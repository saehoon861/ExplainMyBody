# 2ë‹¨ê³„ í”„ë¡¬í”„íŠ¸ ê°€ì´ë“œ

InBody ë¶„ì„ì„ 2ë²ˆì˜ LLM í˜¸ì¶œë¡œ ì²˜ë¦¬í•˜ì—¬ ì •í™•ì„±ê³¼ ì„¸ë°€í•¨ì„ í–¥ìƒ

## ğŸ“‹ ê°œìš”

ê¸°ì¡´ì˜ ë‹¨ì¼ í”„ë¡¬í”„íŠ¸ ë°©ì‹ì—ì„œ **2ë‹¨ê³„ í”„ë¡¬í”„íŠ¸** ë°©ì‹ìœ¼ë¡œ ë³€ê²½:
1. **Prompt 1**: 5ì¤„ í•µì‹¬ ìš”ì•½ (ì²´í˜•, ê·¼ìœ¡, ì§€ë°©, ì‹ë‹¨, ìš´ë™)
2. **Prompt 2**: ì„¸ë¶€ ë¦¬í¬íŠ¸ (ì´ì „ ê¸°ë¡ ë¹„êµ, ê°œì„ ì‚¬í•­, ì£¼ì˜ì‚¬í•­)

## ğŸ¯ ë³€ê²½ ì‚¬ìœ 

### Before (ë‹¨ì¼ í”„ë¡¬í”„íŠ¸)
- í•˜ë‚˜ì˜ ê¸´ í”„ë¡¬í”„íŠ¸ë¡œ ëª¨ë“  ì •ë³´ ìš”ì²­
- LLMì´ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¥´ì§€ ëª»í•˜ëŠ” ê²½ìš° ë°œìƒ
- ìš”ì•½ê³¼ ì„¸ë¶€ì‚¬í•­ì´ í˜¼ì¬ë˜ì–´ ì¼ê´€ì„± ë¶€ì¡±

### After (2ë‹¨ê³„ í”„ë¡¬í”„íŠ¸)
- ê° ë‹¨ê³„ë³„ ëª…í™•í•œ ëª©í‘œì™€ ì¶œë ¥ í˜•ì‹
- ë” ì •í™•í•œ ì‘ë‹µ ìƒì„±
- ì‚¬ìš©ìì—ê²Œ ë‹¨ê³„ë³„ í”¼ë“œë°± ì œê³µ ê°€ëŠ¥

## ğŸ“ Prompt 1: 5ì¤„ ìš”ì•½

### System Prompt
```
ì¸ë°”ë”” ê²°ê³¼ë¥¼ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ 5ì¤„ ìš”ì•½í•©ë‹ˆë‹¤.
ìˆ˜ì¹˜ì™€ êµ¬ì²´ì  ê¶Œì¥ì‚¬í•­ì„ í¬í•¨í•©ë‹ˆë‹¤.
```

### User Prompt
InBodyData í•„ë“œ ê¸°ë°˜:
- ê¸°ë³¸ì •ë³´: ì„±ë³„, ë‚˜ì´, ì‹ ì¥
- í•µì‹¬ ì²´ì„±ë¶„: ì²´ì¤‘, BMI, ì²´ì§€ë°©ë¥ , ê³¨ê²©ê·¼ëŸ‰
- ì¡°ì ˆ ëª©í‘œ: ì²´ì¤‘/ì§€ë°©/ê·¼ìœ¡ ì¡°ì ˆ
- ëŒ€ì‚¬ ì •ë³´: ê¸°ì´ˆëŒ€ì‚¬ëŸ‰, ê¶Œì¥ ì„­ì·¨ ì—´ëŸ‰
- ì²´í˜• ë¶„ë¥˜: Stage 2, Stage 3

### ì¶œë ¥ í˜•ì‹
```
âœ… **ì²´í˜•**: (ì²´í˜• íŒë‹¨ + BMI/ì²´ì§€ë°©ë¥  ìˆ˜ì¹˜ + ê· í˜• í‰ê°€)
âœ… **ê·¼ìœ¡**: (ê³¨ê²©ê·¼ëŸ‰ í‰ê°€ + ê°•í™” í•„ìš” ë¶€ìœ„)
âœ… **ì§€ë°©**: (ì²´ì§€ë°©ë¥ /ë‚´ì¥ì§€ë°© í‰ê°€ + ì£¼ì˜ì‚¬í•­)
âœ… **ì‹ë‹¨**: (ë‹¨ë°±ì§ˆ/ì—´ëŸ‰ ê¸°ì¤€ ê¶Œì¥)
âœ… **ìš´ë™**: (í˜„ì¬ ì²´í˜•ì— ë§ëŠ” êµ¬ì²´ì  ìš´ë™ ì¶”ì²œ)
```

## ğŸ“Š Prompt 2: ì„¸ë¶€ ë¦¬í¬íŠ¸

### System Prompt
```
ì¸ë°”ë”” ì„¸ë¶€ ë¦¬í¬íŠ¸ë¥¼ ì„¹ì…˜ë³„ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
ê° ì„¹ì…˜ ë¶„ëŸ‰ì„ ì •í™•íˆ ì§€í‚µë‹ˆë‹¤.
ê¶Œì¥ì‚¬í•­ì€ êµ¬ì²´ì ì´ê³  ì‹¤ì²œ ê°€ëŠ¥í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
```

### User Prompt
InBodyData ì „ì²´ í•„ë“œ:
- ê¸°ë³¸ì •ë³´
- ì²´ì„±ë¶„ (ì²´ìˆ˜ë¶„, ë‹¨ë°±ì§ˆ, ë¬´ê¸°ì§ˆ, ì²´ì§€ë°©)
- ë¹„ë§Œ ì§€í‘œ (ë³µë¶€ì§€ë°©ë¥ , ë‚´ì¥ì§€ë°©ë ˆë²¨, ë¹„ë§Œë„)
- ëŒ€ì‚¬ ì •ë³´ (ê¸°ì´ˆëŒ€ì‚¬ëŸ‰, ê¶Œì¥ì„­ì·¨ì—´ëŸ‰, ì ì •ì²´ì¤‘)
- ì¡°ì ˆ ëª©í‘œ
- ë¶€ìœ„ë³„ ê·¼ìœ¡/ì²´ì§€ë°© ë“±ê¸‰
- **ì´ì „ ì¸ë°”ë”” ê¸°ë¡** (prev_inbody)
- **ê±´ê°• íŠ¹ì´ì‚¬í•­** (health_notes)

### ì¶œë ¥ í˜•ì‹
```
ğŸ“Š **ì´ì „ ê¸°ë¡ê³¼ì˜ ë³€í™”**
(ì´ì „ ê¸°ë¡ ìˆìœ¼ë©´ 3~5ì¤„ ìˆ˜ì¹˜ ë¹„êµ / ì—†ìœ¼ë©´ "ì´ì „ ê¸°ë¡ ì—†ìŒ")

ğŸ“ˆ **ê°œì„ ì‚¬í•­ ë° ê¶Œì¥ í–‰ë™** (10ì¤„)

âš ï¸ **ê±´ê°• íŠ¹ì´ì‚¬í•­ ë° ì£¼ì˜ í¬ì¸íŠ¸** (10ì¤„)
```

## ğŸ”§ êµ¬í˜„

### prompt_generator_rag.py

```python
def create_inbody_analysis_summary_prompt_with_rag(
    measurements: InBodyMeasurements,
    body_type1: str = "",
    body_type2: str = "",
    rag_context: str = ""
) -> Tuple[str, str]:
    """Prompt 1: 5ì¤„ ìš”ì•½"""
    ...

def create_inbody_analysis_detail_prompt_with_rag(
    measurements: InBodyMeasurements,
    body_type1: str = "",
    body_type2: str = "",
    prev_inbody: str = "",
    health_notes: str = "",
    rag_context: str = ""
) -> Tuple[str, str]:
    """Prompt 2: ì„¸ë¶€ ë¦¬í¬íŠ¸"""
    ...
```

### agent_graph_rag.py

```python
def generate_initial_analysis(state: AnalysisStateRAG) -> dict:
    # 1. RAG ê²€ìƒ‰
    rag_context = ...
    
    # 2. Prompt 1 í˜¸ì¶œ
    summary_response = llm_client.generate_chat(system_1, user_1)
    
    # 3. Prompt 2 í˜¸ì¶œ
    detail_response = llm_client.generate_chat(system_2, user_2)
    
    # 4. ê²°í•©
    combined_response = f"{summary_response}\n\n---\n\n{detail_response}"
    
    # 5. Embedding ìƒì„±
    embedding = create_embedding(combined_response)
    
    return combined_response
```

## ğŸ§ª í…ŒìŠ¤íŠ¸

```bash
cd src/llm/llm_prompt_test_sk
python test_two_step_analysis.py
```

**ì¶œë ¥ ì˜ˆì‹œ:**
```
[Step 1] 5ì¤„ ìš”ì•½ ìƒì„±...
  âœ“ ìš”ì•½ ì™„ë£Œ (450 ë¬¸ì)

[Step 2] ì„¸ë¶€ ë¦¬í¬íŠ¸ ìƒì„±...
  âœ“ ì„¸ë¶€ ë¦¬í¬íŠ¸ ì™„ë£Œ (1200 ë¬¸ì)

[ë¶„ì„ ê²°ê³¼]
âœ… **ì²´í˜•**: Cí˜•(ë³´í†µ ê·¼ìœ¡), BMI 24.5, ì²´ì§€ë°©ë¥  22% - ìƒí•˜ì²´ ê· í˜• ì–‘í˜¸
âœ… **ê·¼ìœ¡**: ê³¨ê²©ê·¼ëŸ‰ 35.5kg í‘œì¤€, ëª¸í†µ ê·¼ìœ¡ ê°•í™” í•„ìš”
...

---

ğŸ“Š **ì´ì „ ê¸°ë¡ê³¼ì˜ ë³€í™”**
ì´ì „ ê¸°ë¡ ì—†ìŒ

ğŸ“ˆ **ê°œì„ ì‚¬í•­ ë° ê¶Œì¥ í–‰ë™**
1. ì²´ì§€ë°©ë¥  22% â†’ 18% ê°ì†Œ ëª©í‘œ (ì¹¼ë¡œë¦¬ ê²°í• í•„ìš”)
...
```

## âœ… ì¥ì 

1. **ì •í™•í•œ í˜•ì‹ ì¤€ìˆ˜**: ê° ë‹¨ê³„ë³„ ëª…í™•í•œ ì¶œë ¥ í˜•ì‹
2. **ì„¸ë°€í•œ ë¶„ì„**: ìš”ì•½ê³¼ ì„¸ë¶€ì‚¬í•­ ë¶„ë¦¬ë¡œ ê¹Šì´ ìˆëŠ” ë¶„ì„
3. **ì´ì „ ê¸°ë¡ í™œìš©**: Prompt 2ì—ì„œ ë³€í™” ì¶”ì 
4. **ê±´ê°• íŠ¹ì´ì‚¬í•­ ë°˜ì˜**: ê°œì¸í™”ëœ ì£¼ì˜ì‚¬í•­ ì œê³µ
5. **InBodyData ì™„ì „ í™œìš©**: ëª¨ë“  í•„ë“œ ì²´ê³„ì  í™œìš©

## ğŸ“Œ ì£¼ì˜ì‚¬í•­

1. **LLM í˜¸ì¶œ 2ë°°**: ë¹„ìš© ë° ì‹œê°„ ì¦ê°€
2. **prev_inbody, health_notes**: DB ì—°ë™ í•„ìš”
3. **ì‘ë‹µ ê²°í•©**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì„¹ì…˜ë³„ íŒŒì‹± í•„ìš”

---

**ì‘ì„±ì¼**: 2026-02-03
