"""
ìš´ë™ ë£¨í‹´ ìƒì„± ì‹œìŠ¤í…œ
- ë£° ê¸°ë°˜ ë¶„ê¸° ì²˜ë¦¬
- ë‹¨ì¼ í”„ë¡¬í”„íŠ¸ + ë™ì  í…ìŠ¤íŠ¸ ì¡°ë¦½
"""

from dataclasses import dataclass, field
from typing import Literal, Optional

# =============================================================================
# 1. íƒ€ì… ì •ì˜
# =============================================================================

BodyType1 = Literal[
    "ë§ˆë¥¸í˜•", "ë§ˆë¥¸ê·¼ìœ¡í˜•", "í‘œì¤€í˜•", "ê·¼ìœ¡í˜•", "ê³ ê·¼ìœ¡ì²´í˜•",
    "ë¹„ë§Œí˜•", "ê³ ë„ë¹„ë§Œí˜•", "ë§ˆë¥¸ë¹„ë§Œí˜•", "ì•Œ ìˆ˜ ì—†ìŒ"
]

BodyType2 = Literal[
    "í‘œì¤€í˜•", "í•˜ì²´ë°œë‹¬í˜•", "ìƒì²´ë°œë‹¬í˜•", "í•˜ì²´ë¹„ë§Œí˜•", "ìƒì²´ë¹„ë§Œí˜•"
]

WorkoutPlace = Literal["í—¬ìŠ¤ì¥", "í™ˆíŠ¸", "ì•„ì›ƒë„ì–´", "ìŠ¤í¬ì¸ "]

SportType = Literal["ì¶•êµ¬", "ë†êµ¬", "í…Œë‹ˆìŠ¤", "ë°°ë“œë¯¼í„´", "ìˆ˜ì˜", "í´ë¼ì´ë°", "ê¸°íƒ€"]


@dataclass
class UserProfile:
    body_type1: BodyType1
    body_type2: BodyType2
    workout_place: WorkoutPlace
    preferred_sport: Optional[SportType] = None  # ìŠ¤í¬ì¸  ì„ íƒ ì‹œì—ë§Œ ì‚¬ìš©


# =============================================================================
# 2. ë£° ì •ì˜ - BODY_TYPE1 (ê·¼ìœ¡ ë³´ì • ì²´í˜•)
# =============================================================================

BODY_TYPE1_RULES: dict[BodyType1, dict] = {
    "ë§ˆë¥¸í˜•": {
        "goal": "ì²´ì¤‘ ì¦ê°€ + ê·¼ìœ¡ëŸ‰ í™•ë³´",
        "diet": "ë°¥, ê³ ê¸° ì¶©ë¶„íˆ ë¨¹ê³  ë¨¹ì€ ê²ƒë³´ë‹¤ ë” ë¨¹ê¸°",
        "training": "ìŠ¤ì¿¼íŠ¸/ë°ë“œë¦¬í”„íŠ¸ ê°™ì€ í° ìš´ë™ ìœ„ì£¼, ë¬´ê²ŒëŠ” ì²œì²œíˆ ì˜¬ë¦¬ê³  ìœ ì‚°ì†ŒëŠ” ìµœì†Œë¡œ",
        "warning": "ìœ ì‚°ì†Œ ë„ˆë¬´ ë§ì´ í•˜ë©´ ì²´ì¤‘ ì•ˆ ëŠ˜ì–´ìš”",
        "coach": "ì§€ê¸ˆì€ ì‚´ ë¹¼ëŠ” ê²Œ ì•„ë‹ˆë¼ ëª¸ì„ ì±„ìš°ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.",
    },
    "ë§ˆë¥¸ê·¼ìœ¡í˜•": {
        "goal": "ê·¼ìœ¡ëŸ‰ ìœ ì§€í•˜ë©° ë²Œí¬ì—…",
        "diet": "ë‹¨ë°±ì§ˆ ë§ì´, ê¹¨ë—í•˜ê²Œ ë¨¹ìœ¼ë©´ì„œ ì²œì²œíˆ ì²´ì¤‘ ëŠ˜ë¦¬ê¸°",
        "training": "ë¶€ìœ„ë³„ë¡œ ë‚˜ëˆ ì„œ ìš´ë™, ë¬´ê²ŒëŠ” ì¡°ê¸ˆì”© ì˜¬ë¦¬ê¸°, ìœ ì‚°ì†Œ ì£¼ 1~2íšŒ",
        "warning": "ê¸‰í•˜ê²Œ ë²Œí¬ì—…í•˜ë©´ ì§€ë°©ë§Œ ëŠ˜ì–´ìš”",
        "coach": "ì´ë¯¸ ì¢‹ì€ ë² ì´ìŠ¤ê°€ ìˆì–´ìš”. ì²œì²œíˆ ìŒ“ì•„ê°€ë©´ ë©ë‹ˆë‹¤.",
    },
    "í‘œì¤€í˜•": {
        "goal": "ì²´ì§€ë°© ì¤„ì´ê³  ê·¼ìœ¡ ëŠ˜ë¦¬ê¸° ê· í˜•ìˆê²Œ",
        "diet": "ê³¨ê³ ë£¨ ë¨¹ë˜ ë‹¨ë°±ì§ˆì€ ê¼­ ì±™ê¸°ê¸°",
        "training": "í° ìš´ë™ + ìœ ì‚°ì†Œ ê°™ì´, ì£¼ 3~4íšŒ",
        "warning": "í•œìª½ì—ë§Œ ì¹˜ìš°ì¹˜ë©´ ë°¸ëŸ°ìŠ¤ ê¹¨ì ¸ìš”",
        "coach": "ê°€ì¥ ì¢‹ì€ ì¶œë°œì ì´ì—ìš”. ê¾¸ì¤€íˆë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.",
    },
    "ê·¼ìœ¡í˜•": {
        "goal": "ê·¼ë ¥ ë” í‚¤ìš°ê³  ì²´ì§€ë°© ê´€ë¦¬",
        "diet": "ë‹¨ë°±ì§ˆ ë†’ê²Œ, íƒ„ìˆ˜í™”ë¬¼ì€ ìš´ë™ ì „í›„ë¡œ",
        "training": "ë¶€ìœ„ë³„ ê°•í•˜ê²Œ, ìœ ì‚°ì†Œ ì£¼ 2íšŒ",
        "warning": "ì˜¤ë²„íŠ¸ë ˆì´ë‹ ì¡°ì‹¬, íœ´ì‹ë„ ìš´ë™ì´ì—ìš”",
        "coach": "ì´ì œ ë””í…Œì¼ ì‹¸ì›€ì…ë‹ˆë‹¤. ë£¨í‹´ ì§€í‚¤ëŠ” ê²Œ í•µì‹¬ì´ì—ìš”.",
    },
    "ê³ ê·¼ìœ¡ì²´í˜•": {
        "goal": "ì§€ê¸ˆ ëª¸ ìœ ì§€í•˜ë©´ì„œ ì»¨ë””ì…˜ ê´€ë¦¬",
        "diet": "ì§€ê¸ˆ ë¨¹ëŠ” ì–‘ ìœ ì§€, ë‹¨ë°±ì§ˆì€ ê³„ì† ë†’ê²Œ",
        "training": "ìš´ë™ëŸ‰ ìœ ì§€í•˜ë˜ ê°€ë”ì€ ê°€ë³ê²Œ ì‰¬ì–´ì£¼ëŠ” ì£¼ë„ í•„ìš”",
        "warning": "ë¬´ë¦¬í•˜ë©´ ë¶€ìƒ ì™€ìš”. íšŒë³µì— ì§‘ì¤‘í•˜ì„¸ìš”",
        "coach": "ì´ë¯¸ ì˜ ë§Œë“¤ì–´ë†¨ì–´ìš”. ìœ ì§€ê°€ ì œì¼ ì–´ë ¤ìš´ ê±° ì•„ì‹œì£ ?",
    },
    "ë¹„ë§Œí˜•": {
        "goal": "ì²´ì§€ë°© ê°ì†Œê°€ ìµœìš°ì„ ",
        "diet": "ë¨¹ëŠ” ì–‘ ì¤„ì´ë˜ ë‹¨ë°±ì§ˆì€ ìœ ì§€, ë°€ê°€ë£¨/ì„¤íƒ• ì¤„ì´ê¸°",
        "training": "ìœ ì‚°ì†Œ + ê·¼ë ¥ ê°™ì´, ê´€ì ˆ ì•ˆ ì•„í”ˆ ìš´ë™ìœ¼ë¡œ",
        "warning": "êµ¶ìœ¼ë©´ ê·¼ìœ¡ë§Œ ë¹ ì ¸ìš”. ì ê²Œ ë¨¹ë˜ ë‹¨ë°±ì§ˆì€ ê¼­",
        "coach": "ì²˜ìŒ í•œ ë‹¬ë§Œ ë²„í‹°ë©´ ëª¸ì´ ë‹¬ë¼ì§€ëŠ” ê²Œ ë³´ì—¬ìš”.",
    },
    "ê³ ë„ë¹„ë§Œí˜•": {
        "goal": "ì²´ì¤‘ ê°ëŸ‰ + ê´€ì ˆ ë³´í˜¸",
        "diet": "ì ê²Œ ë¨¹ë˜ ë‹¨ë°±ì§ˆ ì±™ê¸°ê³  ì±„ì†Œ ë§ì´",
        "training": "ê±·ê¸°/ìˆ˜ì˜ ê°™ì€ ê°€ë²¼ìš´ ìœ ì‚°ì†Œ, ë§¨ëª¸ ê·¼ë ¥, ì²œì²œíˆ ê°•ë„ ì˜¬ë¦¬ê¸°",
        "warning": "ë¬´ë¦/í—ˆë¦¬ ì¡°ì‹¬í•˜ì„¸ìš”. ì•‰ì•„ì„œ í•˜ëŠ” ìš´ë™ë¶€í„°",
        "coach": "ê¸‰í•˜ê²Œ ê°€ë©´ ë‹¤ì³ìš”. ì²œì²œíˆ ê°€ëŠ” ê²Œ ì œì¼ ë¹ ë¥¸ ê¸¸ì…ë‹ˆë‹¤.",
    },
    "ë§ˆë¥¸ë¹„ë§Œí˜•": {
        "goal": "ì²´ì§€ë°© ì¤„ì´ë©´ì„œ ê·¼ìœ¡ ëŠ˜ë¦¬ê¸° ë™ì‹œì—",
        "diet": "ë‹¨ë°±ì§ˆ ë§ì´, ë°¥ì€ í˜„ë¯¸/ê³ êµ¬ë§ˆ ê°™ì€ ì¢‹ì€ íƒ„ìˆ˜í™”ë¬¼ë¡œ",
        "training": "ê·¼ë ¥ìš´ë™ì´ ë©”ì¸, ìœ ì‚°ì†ŒëŠ” ë³´ì¡°ë¡œë§Œ",
        "warning": "ìœ ì‚°ì†Œë§Œ í•˜ë©´ ë” ë§ˆë¥´ê¸°ë§Œ í•´ìš”. ê·¼ë ¥ì´ ìš°ì„ ì´ì—ìš”",
        "coach": "ì²´ì¤‘ê³„ ìˆ«ìë³´ë‹¤ ê±°ìš¸ì„ ë¯¿ìœ¼ì„¸ìš”. ê·¼ìœ¡ì´ ë¶™ìœ¼ë©´ ë‹¬ë¼ì ¸ìš”.",
    },
    "ì•Œ ìˆ˜ ì—†ìŒ": {
        "goal": "ê¸°ë³¸ ì²´ë ¥ í–¥ìƒ",
        "diet": "ê· í˜• ì¡íŒ ì‹ë‹¨ ê¶Œì¥",
        "training": "ì „ì‹  ìš´ë™ ì£¼ 3íšŒ ê¶Œì¥",
        "warning": "ì •í™•í•œ ì²´í˜• ì¸¡ì • í›„ ë§ì¶¤ í”Œëœ ì¶”ì²œë“œë ¤ìš”",
        "coach": "ì¼ë‹¨ ì‹œì‘í•˜ëŠ” ê²Œ ì¤‘ìš”í•´ìš”. ê°™ì´ í•´ë´ìš”!",
    },
}


# =============================================================================
# 3. ë£° ì •ì˜ - BODY_TYPE2 (ìƒí•˜ì²´ ë°¸ëŸ°ìŠ¤)
# =============================================================================

BODY_TYPE2_RULES: dict[BodyType2, dict] = {
    "í‘œì¤€í˜•": {
        "focus": "ìƒí•˜ì²´ ê· í˜• ìœ ì§€",
        "training_adjust": "ìƒì²´/í•˜ì²´ ë¹„ìœ¨ 1:1ë¡œ êµ¬ì„±",
        "coach": "ë°¸ëŸ°ìŠ¤ ì¢‹ì•„ìš”. ì´ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ ì „ì²´ì ìœ¼ë¡œ í‚¤ì›Œê°€ìš”.",
    },
    "í•˜ì²´ë°œë‹¬í˜•": {
        "focus": "ìƒì²´ ê°•í™” í•„ìš”",
        "training_adjust": "ìƒì²´ ìš´ë™ ë” ìì£¼, í•˜ì²´ëŠ” ìœ ì§€ë§Œ",
        "coach": "í•˜ì²´ëŠ” ì´ë¯¸ ì¶©ë¶„í•´ìš”. ìƒì²´ ì±„ìš°ë©´ ë¹„ìœ¨ ì˜ˆë»ì ¸ìš”.",
    },
    "ìƒì²´ë°œë‹¬í˜•": {
        "focus": "í•˜ì²´ ê°•í™” í•„ìš”",
        "training_adjust": "í•˜ì²´ ìš´ë™ ë” ìì£¼, ìŠ¤ì¿¼íŠ¸/ëŸ°ì§€ í•„ìˆ˜",
        "coach": "í•˜ì²´ê°€ ë°›ì³ì¤˜ì•¼ ìƒì²´ë„ ë” ì»¤ ë³´ì—¬ìš”. ìŠ¤ì¿¼íŠ¸ í•©ì‹œë‹¤.",
    },
    "í•˜ì²´ë¹„ë§Œí˜•": {
        "focus": "í•˜ì²´ ì²´ì§€ë°© ê°ì†Œ + ìƒì²´ ê·¼ìœ¡ ê°•í™”",
        "training_adjust": "í•˜ì²´ëŠ” ìœ ì‚°ì†Œ+ê°€ë²¼ìš´ ê·¼ë ¥, ìƒì²´ëŠ” ê·¼ë ¥ ì§‘ì¤‘",
        "coach": "í•˜ì²´ëŠ” ëŠ¦ê²Œ ë¹ ì§€ì§€ë§Œ ë¹ ì§€ë©´ ì§„ì§œ í¬ê²Œ ë°”ë€ë‹ˆë‹¤.",
    },
    "ìƒì²´ë¹„ë§Œí˜•": {
        "focus": "ìƒì²´ ì²´ì§€ë°© ê°ì†Œ + í•˜ì²´ ê·¼ë ¥ ê°•í™”",
        "training_adjust": "ì „ì‹  ìœ ì‚°ì†Œë¡œ ìƒì²´ ë¹¼ê³ , í•˜ì²´ ê·¼ë ¥ ì§‘ì¤‘",
        "coach": "í•˜ì²´ í‚¤ìš°ë©´ ìƒì²´ê°€ ìƒëŒ€ì ìœ¼ë¡œ ë‚ ì”¬í•´ ë³´ì—¬ìš”.",
    },
}


# =============================================================================
# 4. ë£° ì •ì˜ - WORKOUT_PLACE (ìš´ë™ ì¥ì†Œ)
# =============================================================================

WORKOUT_PLACE_RULES: dict[WorkoutPlace, dict] = {
    "í—¬ìŠ¤ì¥": {
        "environment": "ë¨¸ì‹ ê³¼ ì¤‘ëŸ‰ì„ í™œìš©í•  ìˆ˜ ìˆì–´ ê·¼ë ¥ íš¨ìœ¨ì´ ìµœê³ ì…ë‹ˆë‹¤.",
        "routine_style": "ìŠ¤ì¿¼íŠ¸/ë«í’€ë‹¤ìš´/ë²¤ì¹˜ ê°™ì€ ì •ì„ ë£¨í‹´ìœ¼ë¡œ ê°‘ë‹ˆë‹¤.",
        "constraints": "ë¬´ê²Œë³´ë‹¤ ìì„¸ê°€ ìš°ì„ ì…ë‹ˆë‹¤.",
        "coach": "í—¬ìŠ¤ì¥ì€ ë¬´ê²Œë³´ë‹¤ ë£¨í‹´ì´ ë¨¼ì €ì…ë‹ˆë‹¤.",
    },
    "í™ˆíŠ¸": {
        "environment": "ì¥ë¹„ê°€ ì œí•œì ì´ë¼ ë§¨ëª¸ ë£¨í‹´ì´ í•µì‹¬ì…ë‹ˆë‹¤.",
        "routine_style": "ìŠ¤ì¿¼íŠ¸/í‘¸ì‰¬ì—…/ëŸ°ì§€/í”Œë­í¬ ìœ„ì£¼ë¡œ êµ¬ì„±í•˜ì„¸ìš”.",
        "constraints": "ê°•ë„ëŠ” ì„¸íŠ¸ ìˆ˜ë¡œ ì˜¬ë¦¬ë©´ ë©ë‹ˆë‹¤.",
        "coach": "ì§‘ì—ì„œë„ ì¶©ë¶„íˆ ë©ë‹ˆë‹¤. ê¾¸ì¤€í•¨ì´ ì¥ë¹„ë¥¼ ì´ê²¨ìš”.",
    },
    "ì•„ì›ƒë„ì–´": {
        "environment": "í™œë™ëŸ‰ì„ í¬ê²Œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ìµœê³ ì˜ í™˜ê²½ì…ë‹ˆë‹¤.",
        "routine_style": "ê±·ê¸°/ëŸ¬ë‹ + í•˜ì²´ ë³´ì™„ ìš´ë™ì„ ì„ìŠµë‹ˆë‹¤.",
        "constraints": "ë¬´ë¦ ë¶€ë‹´ ìˆìœ¼ë©´ ê±·ê¸°ë¶€í„° ì‹œì‘í•˜ì„¸ìš”.",
        "coach": "ë°”ê¹¥ ê³µê¸° ë§ˆì‹œë©´ì„œ í•˜ëŠ” ìš´ë™ì´ ì œì¼ ì˜¤ë˜ ê°‘ë‹ˆë‹¤.",
    },
    "ìŠ¤í¬ì¸ ": {
        "environment": "ì¬ë¯¸ë¡œ ê¾¸ì¤€íˆ í•  ìˆ˜ ìˆëŠ” ìš´ë™ì´ ê°€ì¥ ê°•ë ¥í•©ë‹ˆë‹¤.",
        "routine_style": "ìŠ¤í¬ì¸ ëŠ” ì£¼ 2~3íšŒ, ë‚˜ë¨¸ì§€ëŠ” í•˜ì²´+ì½”ì–´ ë³´ì™„ ê·¼ë ¥ìš´ë™",
        "constraints": "ìŠ¤í¬ì¸ ë§Œ í•˜ë©´ ê·¼ì†ì‹¤ ë‚˜ë‹ˆ ê·¼ë ¥ì€ ê¼­ ë„£ìŠµë‹ˆë‹¤.",
        "coach": "ì¢‹ì•„í•˜ëŠ” ìš´ë™ì´ ìµœê³ ì˜ ìš´ë™ì´ì—ìš”. ê·¼ë ¥ë§Œ ë³´ì™„í•˜ë©´ ì™„ë²½í•©ë‹ˆë‹¤.",
    },
}

# ìŠ¤í¬ì¸  ì¢…ë¥˜ë³„ ë³´ì™„ ìš´ë™ (preferred_sportê°€ ìˆì„ ë•Œ ì‚¬ìš©)
SPORT_SUPPLEMENT_RULES: dict[SportType, dict] = {
    "ì¶•êµ¬": {
        "focus": "í•˜ì²´ ì§€êµ¬ë ¥ + ì½”ì–´",
        "supplement": "ëŸ°ì§€, í”Œë­í¬, í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­",
        "warning": "ë°œëª©/ë¬´ë¦ ë¶€ìƒ ì£¼ì˜",
    },
    "ë†êµ¬": {
        "focus": "ì í”„ë ¥ + ì–´ê¹¨/ì½”ì–´",
        "supplement": "ìŠ¤ì¿¼íŠ¸ì í”„, ìˆ„ë”í”„ë ˆìŠ¤, ì½”ì–´",
        "warning": "ë°œëª© ì ‘ì§ˆë¦¼ ì£¼ì˜",
    },
    "í…Œë‹ˆìŠ¤": {
        "focus": "ì–´ê¹¨/íŒ” + í•˜ì²´ ìˆœë°œë ¥",
        "supplement": "ë¡œí…Œì´í„°ì»¤í”„, ì‚¬ì´ë“œëŸ°ì§€, ì½”ì–´",
        "warning": "íŒ”ê¿ˆì¹˜/ì–´ê¹¨ ê³¼ì‚¬ìš© ì£¼ì˜",
    },
    "ë°°ë“œë¯¼í„´": {
        "focus": "ì–´ê¹¨/ì†ëª© + í•˜ì²´ ìˆœë°œë ¥",
        "supplement": "ìˆ„ë” ìŠ¤íŠ¸ë ˆì¹­, ëŸ°ì§€, ì¢…ì•„ë¦¬",
        "warning": "ì†ëª©/ì–´ê¹¨ ë¶€ìƒ ì£¼ì˜",
    },
    "ìˆ˜ì˜": {
        "focus": "ì „ì‹  ë°¸ëŸ°ìŠ¤ ì¢‹ìŒ",
        "supplement": "ì½”ì–´ + í•˜ì²´ ê·¼ë ¥ ë³´ì™„",
        "warning": "ì–´ê¹¨ ê³¼ì‚¬ìš© ì‹œ íœ´ì‹ í•„ìš”",
    },
    "í´ë¼ì´ë°": {
        "focus": "ë“±/íŒ” + ì½”ì–´",
        "supplement": "í•˜ì²´ ê·¼ë ¥ ë³´ì™„, ìŠ¤íŠ¸ë ˆì¹­ í•„ìˆ˜",
        "warning": "ì†ê°€ë½/íŒ”ê¿ˆì¹˜ ê³¼ì‚¬ìš© ì£¼ì˜",
    },
    "ê¸°íƒ€": {
        "focus": "ì „ì‹  ê· í˜•",
        "supplement": "ì½”ì–´ + ìœ ì—°ì„± ìš´ë™",
        "warning": "ë³¸ì¸ ì¢…ëª© íŠ¹ì„±ì— ë§ê²Œ ì¡°ì ˆ",
    },
}


# =============================================================================
# 5. ì „ëµ í…ìŠ¤íŠ¸ ì¡°ë¦½
# =============================================================================

def build_strategy_text(user: UserProfile) -> str:
    """ë£° 3ê°œë¥¼ ì¡°í•©í•´ì„œ ì „ëµ í…ìŠ¤íŠ¸ ìƒì„± (fallback í¬í•¨)"""
    
    # fallbackìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë£° ê°€ì ¸ì˜¤ê¸°
    t1 = BODY_TYPE1_RULES.get(user.body_type1, BODY_TYPE1_RULES["ì•Œ ìˆ˜ ì—†ìŒ"])
    t2 = BODY_TYPE2_RULES.get(user.body_type2, BODY_TYPE2_RULES["í‘œì¤€í˜•"])
    tp = WORKOUT_PLACE_RULES.get(user.workout_place, WORKOUT_PLACE_RULES["í—¬ìŠ¤ì¥"])
    
    strategy_text = f"""
[ì „ì²´ ì²´í˜• ì „ëµ]
- ëª©í‘œ: {t1['goal']}
- ì‹ë‹¨: {t1['diet']}
- ìš´ë™: {t1['training']}
- âš ï¸ ì£¼ì˜: {t1['warning']}
- ğŸ’¬ ì½”ì¹˜: {t1['coach']}

[ìƒí•˜ì²´ ë°¸ëŸ°ìŠ¤]
- í¬ì»¤ìŠ¤: {t2['focus']}
- ë£¨í‹´ ì¡°ì •: {t2['training_adjust']}
- ğŸ’¬ ì½”ì¹˜: {t2['coach']}

[ìš´ë™ ì¥ì†Œ: {user.workout_place}]
- í™˜ê²½: {tp['environment']}
- ìŠ¤íƒ€ì¼: {tp['routine_style']}
- ì£¼ì˜: {tp['constraints']}
- ğŸ’¬ ì½”ì¹˜: {tp['coach']}
"""
    
    # ìŠ¤í¬ì¸  ì„ íƒ ì‹œ ë³´ì™„ ìš´ë™ ì¶”ê°€
    if user.workout_place == "ìŠ¤í¬ì¸ " and user.preferred_sport:
        sport = SPORT_SUPPLEMENT_RULES.get(user.preferred_sport, SPORT_SUPPLEMENT_RULES["ê¸°íƒ€"])
        strategy_text += f"""
[ì„ íƒ ìŠ¤í¬ì¸ : {user.preferred_sport}]
- ì§‘ì¤‘ ë¶€ìœ„: {sport['focus']}
- ë³´ì™„ ìš´ë™: {sport['supplement']}
- âš ï¸ ë¶€ìƒ ì£¼ì˜: {sport['warning']}
"""
    
    return strategy_text.strip()


# =============================================================================
# 6. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ (ë‹¨ì¼)
# =============================================================================

WEEKLY_PLAN_PROMPT_TEMPLATE = """
ë„ˆëŠ” ì „ë¬¸ PT ì½”ì¹˜ë‹¤.

ì•„ë˜ ì „ëµì„ **ë°˜ë“œì‹œ** ë°˜ì˜í•´ì„œ ì›”~ì¼ ì£¼ê°„ ìš´ë™ ë£¨í‹´ì„ ì‘ì„±í•´ë¼.

{strategy_text}

---

ì¶œë ¥ ê·œì¹™:
- ìš´ë™ì¼: ë©”ì¸ìš´ë™ / ë³´ì¡°ìš´ë™ / ë§ˆë¬´ë¦¬ (3ì¤„)
- íœ´ì‹ì¼: ê°€ë²¼ìš´ í™œë™ 1ì¤„ (ì˜ˆ: ì‚°ì±… 30ë¶„)
- ë§íˆ¬ëŠ” ì§§ê³  í™•ì‹  ìˆê²Œ
- ë¶ˆí•„ìš”í•œ ì„¤ëª… ê¸ˆì§€

ì¶œë ¥ í˜•ì‹:
ì›”: [ìš´ë™ ë‚´ìš©]
í™”: [ìš´ë™ ë‚´ìš©]
ìˆ˜: [ìš´ë™ ë‚´ìš©]
ëª©: [ìš´ë™ ë‚´ìš©]
ê¸ˆ: [ìš´ë™ ë‚´ìš©]
í† : [ìš´ë™ ë‚´ìš©]
ì¼: [ìš´ë™ ë‚´ìš©]
"""


def build_final_prompt(user: UserProfile) -> str:
    """ìµœì¢… í”„ë¡¬í”„íŠ¸ ìƒì„±"""
    strategy_text = build_strategy_text(user)
    return WEEKLY_PLAN_PROMPT_TEMPLATE.format(strategy_text=strategy_text)


# =============================================================================
# 7. ì„œë¹„ìŠ¤ ë ˆì´ì–´ (LLM í˜¸ì¶œ)
# =============================================================================

class WeeklyPlanService:
    """ì£¼ê°„ ìš´ë™ ë£¨í‹´ ìƒì„± ì„œë¹„ìŠ¤"""
    
    def __init__(self, llm_client):
        """
        llm_client: OpenAI í˜¸í™˜ í´ë¼ì´ì–¸íŠ¸
            - openai.OpenAI()
            - Ollama client
            - ê¸°íƒ€ í˜¸í™˜ í´ë¼ì´ì–¸íŠ¸
        """
        self.llm = llm_client
    
    def generate_weekly_plan(self, user: UserProfile, model: str = "gpt-4o-mini") -> str:
        """
        ì‹¤í–‰ íë¦„:
        1. ë£° ì„ íƒ (ì½”ë“œì—ì„œ ìë™)
        2. ì „ëµ í…ìŠ¤íŠ¸ ì¡°ë¦½
        3. í”„ë¡¬í”„íŠ¸ ìƒì„±
        4. LLM í˜¸ì¶œ
        """
        prompt = build_final_prompt(user)
        
        response = self.llm.chat.completions.create(
            model=model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
        )
        
        return response.choices[0].message.content


# =============================================================================
# 8. ì‚¬ìš© ì˜ˆì‹œ
# =============================================================================

if __name__ == "__main__":
    # ì˜ˆì‹œ 1: í™ˆíŠ¸ ì‚¬ìš©ì (í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°)
    test_user1 = UserProfile(
        body_type1="ë§ˆë¥¸ë¹„ë§Œí˜•",
        body_type2="í•˜ì²´ë¹„ë§Œí˜•",
        workout_place="í™ˆíŠ¸"
    )
    
    print("=" * 60)
    print("ğŸ“‹ ì˜ˆì‹œ 1: ë§ˆë¥¸ë¹„ë§Œí˜• + í•˜ì²´ë¹„ë§Œí˜• + í™ˆíŠ¸")
    print("=" * 60)
    print(build_strategy_text(test_user1))
    
    # ì˜ˆì‹œ 2: ìŠ¤í¬ì¸  ì‚¬ìš©ì (ì¶•êµ¬)
    test_user2 = UserProfile(
        body_type1="í‘œì¤€í˜•",
        body_type2="ìƒì²´ë°œë‹¬í˜•",
        workout_place="ìŠ¤í¬ì¸ ",
        preferred_sport="ì¶•êµ¬"
    )
    
    print("\n" + "=" * 60)
    print("ğŸ“‹ ì˜ˆì‹œ 2: í‘œì¤€í˜• + ìƒì²´ë°œë‹¬í˜• + ìŠ¤í¬ì¸ (ì¶•êµ¬)")
    print("=" * 60)
    print(build_strategy_text(test_user2))
    
    # ì˜ˆì‹œ 3: ì˜ëª»ëœ ì…ë ¥ í…ŒìŠ¤íŠ¸ (fallback í™•ì¸)
    test_user3 = UserProfile(
        body_type1="ì´ìƒí•œê°’",  # type: ignore - í…ŒìŠ¤íŠ¸ìš©
        body_type2="í‘œì¤€í˜•",
        workout_place="í—¬ìŠ¤ì¥"
    )
    
    print("\n" + "=" * 60)
    print("ğŸ“‹ ì˜ˆì‹œ 3: ì˜ëª»ëœ body_type1 ì…ë ¥ â†’ fallback ë™ì‘")
    print("=" * 60)
    print(build_strategy_text(test_user3))
    
    print("\n" + "=" * 60)
    print("ğŸ“ ìµœì¢… í”„ë¡¬í”„íŠ¸ (ì˜ˆì‹œ 1)")
    print("=" * 60)
    print(build_final_prompt(test_user1))
    
    # ì‹¤ì œ LLM í˜¸ì¶œ (ì£¼ì„ í•´ì œí•´ì„œ ì‚¬ìš©)
    # from openai import OpenAI
    # client = OpenAI()
    # service = WeeklyPlanService(client)
    # result = service.generate_weekly_plan(test_user1)
    # print(result)
