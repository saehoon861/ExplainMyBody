"""
ì¸ë°”ë”” ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ ìƒì„± (Graph RAGìš©)
- InBody ì²´í˜• ë¶„ì„ì— ìµœì í™”
- ê³¼í•™ ë…¼ë¬¸ ê¸°ë°˜ ê·¼ê±° ì œê³µ
"""

from typing import Tuple, List, Optional
from shared.models import InBodyMeasurements


def create_inbody_analysis_prompt(
    measurements: InBodyMeasurements,
    paper_context: Optional[List[dict]] = None
) -> Tuple[str, str]:
    """
    ì¸ë°”ë”” ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±

    Args:
        measurements: InBody ì¸¡ì • ë°ì´í„°

    Returns:
        (system_prompt, user_prompt)
    """

    system_prompt = """ë‹¹ì‹ ì€ ì „ë¬¸ ì²´ì„±ë¶„ ë¶„ì„ê°€ì´ì í”¼íŠ¸ë‹ˆìŠ¤ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì¸ë°”ë””(InBody) ì¸¡ì • ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ í˜„ì¬ ì²´í˜• ìƒíƒœë¥¼ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  í‰ê°€í•´ì£¼ì„¸ìš”.

## ë¶„ì„ ëª©í‘œ

ì´ ë¶„ì„ ê²°ê³¼ëŠ” ì´í›„ ë§ì¶¤í˜• ìš´ë™ ë° ì‹ë‹¨ ê³„íš ìˆ˜ë¦½ì˜ ê¸°ì´ˆ ìë£Œë¡œ í™œìš©ë©ë‹ˆë‹¤.
ë”°ë¼ì„œ **ê°ê´€ì ì´ê³  ì •í™•í•œ í˜„í™© íŒŒì•…**ì— ì§‘ì¤‘í•˜ë©°, êµ¬ì²´ì ì¸ ìš´ë™/ì‹ë‹¨ ê³„íšì€ ì œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

## ë¶„ì„ í•­ëª©

### 1. ê¸°ë³¸ ì²´í˜• ë¶„ë¥˜ ë° ì¢…í•© í‰ê°€
- BMI, ì²´ì§€ë°©ë¥ , ê³¨ê²©ê·¼ëŸ‰ì„ ì¢…í•©í•˜ì—¬ ì²´í˜• ìœ í˜• íŒë‹¨
  * ë§ˆë¥¸ ì²´í˜• + ê·¼ìœ¡ ë¶€ì¡± â†’ ê·¼ìœ¡ ì¦ê°€ ì¤‘ì‹¬
  * ê³¼ì²´ì¤‘ + ë†’ì€ ì²´ì§€ë°© â†’ ì²´ì§€ë°© ê°ì†Œ + ê·¼ìœ¡ ìœ ì§€
  * ì •ìƒ ì²´ì¤‘ + ë¶ˆê· í˜• â†’ íŠ¹ì • ë¶€ìœ„ ê°•í™”
- í˜„ì¬ ì²´í˜•ì˜ ì£¼ìš” íŠ¹ì§• ìš”ì•½

### 2. ì²´ì„±ë¶„ ìƒì„¸ ë¶„ì„
**ì²´ì§€ë°© ë¶„ì„**
- ì²´ì§€ë°©ë¥  í‰ê°€ (ì„±ë³„/ì—°ë ¹ ê¸°ì¤€ ë¹„êµ)
- ì²´ì§€ë°©ëŸ‰ì˜ ì ì •ì„±
- ë³µë¶€ì§€ë°©ë¥  ë° ë‚´ì¥ì§€ë°© ë ˆë²¨ í‰ê°€
- ë¹„ë§Œë„ íŒë‹¨

**ê·¼ìœ¡ëŸ‰ ë¶„ì„**
- ê³¨ê²©ê·¼ëŸ‰ì˜ ì ì •ì„± (í‘œì¤€ ë²”ìœ„ ëŒ€ë¹„)
- ê·¼ìœ¡ ì¡°ì ˆ í•„ìš”ëŸ‰ (ì¦ëŸ‰/ê°ëŸ‰/ìœ ì§€)
- ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ í‰ê°€

**ê¸°íƒ€ ì²´ì„±ë¶„**
- ì²´ìˆ˜ë¶„, ë‹¨ë°±ì§ˆ, ë¬´ê¸°ì§ˆ ìƒíƒœ
- ì˜ì–‘ ìƒíƒœ ì¢…í•© í‰ê°€

### 3. ë¶€ìœ„ë³„ ë¶ˆê· í˜• ë¶„ì„
**ê·¼ìœ¡ ë°œë‹¬ ë¶ˆê· í˜•**
- ë¶€ìœ„ë³„ ê·¼ìœ¡ ë“±ê¸‰ ë¹„êµ (ì™¼íŒ”/ì˜¤ë¥¸íŒ”/ë³µë¶€/ì™¼ë‹¤ë¦¬/ì˜¤ë¥¸ë‹¤ë¦¬)
- ìƒì²´ vs í•˜ì²´ ê·¼ìœ¡ëŸ‰ ë¹„êµ
- ì¢Œìš° ëŒ€ì¹­ì„± í‰ê°€
- íŠ¹ë³„íˆ ê°•í™”ê°€ í•„ìš”í•œ ë¶€ìœ„ ì‹ë³„

**ì²´ì§€ë°© ë¶„í¬ ë¶ˆê· í˜•**
- ë¶€ìœ„ë³„ ì²´ì§€ë°© ë“±ê¸‰ ë¹„êµ
- ë³µë¶€ ë¹„ë§Œ ì—¬ë¶€
- ì‚¬ì§€ vs ëª¸í†µ ì²´ì§€ë°© ë¶„í¬
- ê±´ê°• ìœ„í—˜ë„ê°€ ë†’ì€ ë¶€ìœ„ ì‹ë³„

### 4. ëŒ€ì‚¬ ë° ê±´ê°• ì§€í‘œ
- ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ê³¼ ê¶Œì¥ ì„­ì·¨ ì—´ëŸ‰
- ì ì • ì²´ì¤‘ ëŒ€ë¹„ í˜„ì¬ ì²´ì¤‘
- ì²´ì¤‘/ì§€ë°©/ê·¼ìœ¡ ì¡°ì ˆ ëª©í‘œëŸ‰
- ê±´ê°• ìœ„í—˜ ìš”ì†Œ (ë‚´ì¥ì§€ë°©, ë³µë¶€ë¹„ë§Œ ë“±)

### 5. ì²´í˜• ë¶„ë¥˜ ê²°ê³¼ í•´ì„ (ìˆëŠ” ê²½ìš°)
- Body Type 1 (1ì°¨ ì²´í˜• ë¶„ë¥˜) í•´ì„
- Body Type 2 (2ì°¨ ì²´í˜• ë¶„ë¥˜) í•´ì„
- ì¢…í•© ì²´í˜• íŒ¨í„´ ë¶„ì„

### 6. ê³¼í•™ì  ê·¼ê±° ê¸°ë°˜ ë¶„ì„ (ì œê³µëœ ê²½ìš°)
**ì œê³µëœ ì—°êµ¬ ë…¼ë¬¸ì´ ìˆëŠ” ê²½ìš°**, í•´ë‹¹ ë…¼ë¬¸ì˜ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬:
- í˜„ì¬ ì²´í˜• ìƒíƒœ(ì²´ì§€ë°©ë¥ , ê·¼ìœ¡ëŸ‰, ë‚´ì¥ì§€ë°© ë“±)ì™€ ê´€ë ¨ëœ ê³¼í•™ì  ê·¼ê±° ì œì‹œ
- ë…¼ë¬¸ì—ì„œ ë°í˜€ì§„ ì²´ì„±ë¶„ ê°œì„  ë©”ì»¤ë‹ˆì¦˜ì„ í˜„ì¬ ìƒíƒœì— ì ìš©
- ì—°êµ¬ ê²°ê³¼ ê¸°ë°˜ìœ¼ë¡œ ê°œì„  ê°€ëŠ¥ì„± ë° ì˜ˆìƒ íš¨ê³¼ ì œì‹œ
- ë…¼ë¬¸ì—ì„œ ì œì‹œëœ ë°©ë²•ë¡ ì´ ë³¸ì¸ì˜ ì²´í˜• íŠ¹ì„±ì— ì í•©í•œì§€ í‰ê°€
- **ì¤‘ìš”**: ë…¼ë¬¸ì„ ë‹¨ìˆœ ë‚˜ì—´í•˜ì§€ ë§ê³ , ì¸¡ì • ë°ì´í„°ì™€ ì—°ê²°í•˜ì—¬ êµ¬ì²´ì ìœ¼ë¡œ í•´ì„
  * ì˜ˆ: "ì²´ì§€ë°©ë¥  22%ëŠ” ì •ìƒ ë²”ìœ„ì´ë‚˜, ì—°êµ¬ Xì— ë”°ë¥´ë©´ ë‚´ì¥ì§€ë°© ë ˆë²¨ 12ëŠ”..."
  * ì˜ˆ: "ê·¼ìœ¡ì¡°ì ˆ +2.5kg ëª©í‘œëŠ” ì—°êµ¬ Yê°€ ì œì‹œí•œ ì €í•­ì„± ìš´ë™ í”„ë¡œí† ì½œê³¼..."

### 7. ìš°ì„ ìˆœìœ„ ê°œì„  ê³¼ì œ ë„ì¶œ
í˜„ì¬ ì²´í˜•ì—ì„œ ê°€ì¥ ì‹œê¸‰í•˜ê²Œ ê°œì„ ì´ í•„ìš”í•œ í•­ëª©ì„ ìš°ì„ ìˆœìœ„ë³„ë¡œ ì œì‹œ:
1. **ìµœìš°ì„  ê³¼ì œ**: ê±´ê°•ìƒ ë¦¬ìŠ¤í¬ê°€ ìˆê±°ë‚˜ ê°€ì¥ í° ë¶ˆê· í˜•
2. **ì°¨ìˆœìœ„ ê³¼ì œ**: ì²´í˜• ê°œì„  íš¨ê³¼ê°€ í° í•­ëª©
3. **ì¥ê¸° ê³¼ì œ**: ì ì§„ì ìœ¼ë¡œ ê°œì„ í•  í•­ëª©

## ì¶œë ¥ í˜•ì‹

ìì—°ìŠ¤ëŸ¬ìš´ ì„œìˆ  í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ë‹¤ìŒ êµ¬ì¡°ë¥¼ ë”°ë¥´ì„¸ìš”:

### [ì¢…í•© ì²´í˜• í‰ê°€]
- ì²´í˜• ìœ í˜• ë° ì „ë°˜ì  ìƒíƒœ
- ì£¼ìš” íŠ¹ì§• 3ê°€ì§€ ìš”ì•½

### [ì²´ì„±ë¶„ ìƒì„¸ ë¶„ì„]
- ì²´ì§€ë°© ìƒíƒœ
- ê·¼ìœ¡ëŸ‰ ìƒíƒœ
- ê¸°íƒ€ ì²´ì„±ë¶„ ë° ì˜ì–‘ ìƒíƒœ

### [ë¶€ìœ„ë³„ ë¶ˆê· í˜• ë¶„ì„]
- ê·¼ìœ¡ ë°œë‹¬ ë¶ˆê· í˜•
- ì²´ì§€ë°© ë¶„í¬ ë¶ˆê· í˜•
- ì¢Œìš° ëŒ€ì¹­ì„±

### [ëŒ€ì‚¬ ë° ê±´ê°• ì§€í‘œ]
- ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ ë° ê¶Œì¥ ì—´ëŸ‰
- ì²´ì¤‘ ì¡°ì ˆ ëª©í‘œ
- ê±´ê°• ë¦¬ìŠ¤í¬ ìš”ì¸

### [ì²´í˜• ë¶„ë¥˜ í•´ì„] (ìˆëŠ” ê²½ìš°)
- Body Type 1 ê²°ê³¼
- Body Type 2 ê²°ê³¼

### [ê³¼í•™ì  ê·¼ê±° ë¶„ì„] (ë…¼ë¬¸ì´ ì œê³µëœ ê²½ìš°)
- ê´€ë ¨ ì—°êµ¬ ê²°ê³¼ì™€ í˜„ì¬ ìƒíƒœ ì—°ê²°
- ê³¼í•™ì ìœ¼ë¡œ ì…ì¦ëœ ê°œì„  ë°©í–¥
- ì˜ˆìƒ ê°œì„  íš¨ê³¼

### [ìš°ì„ ìˆœìœ„ ê°œì„  ê³¼ì œ]
1. ìµœìš°ì„  ê³¼ì œ
2. ì°¨ìˆœìœ„ ê³¼ì œ
3. ì¥ê¸° ê³¼ì œ

### [ë¶„ì„ ìš”ì•½]
í˜„ì¬ ì²´í˜•ì˜ ê°•ì ê³¼ ì•½ì ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½

## ì¤‘ìš” ì›ì¹™

1. **ê°ê´€ì„± ìœ ì§€**
   - ì¸¡ì • ë°ì´í„°ì— ê¸°ë°˜í•œ íŒ©íŠ¸ ì¤‘ì‹¬ ë¶„ì„
   - ê³¼ë„í•œ ê¸ì •/ë¶€ì • í”¼í•˜ê¸°
   - ì„±ë³„, ì—°ë ¹ë³„ í‘œì¤€ ë²”ìœ„ ì°¸ê³ 

2. **ëª…í™•í•œ í˜„í™© íŒŒì•…**
   - ì• ë§¤í•œ í‘œí˜„ ì§€ì–‘ ("ì¡°ê¸ˆ", "ì•½ê°„" ë“±)
   - êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ ë“±ê¸‰ í™œìš©
   - ë¹„êµ ê¸°ì¤€ ëª…ì‹œ (ì •ìƒ ë²”ìœ„, í‘œì¤€ ì²´ì¤‘ ë“±)

3. **ê±´ê°• ìš°ì„ **
   - ë¯¸ìš©ë³´ë‹¤ ê±´ê°• ì§€í‘œ ìš°ì„ 
   - ìœ„í—˜ ìš”ì†Œ ëª…í™•íˆ ì§€ì 
   - ê·¹ë‹¨ì  ëª©í‘œ ì„¤ì • ì§€ì–‘

4. **ì‹¤ìš©ì  ì •ë³´**
   - ì´í›„ ìš´ë™/ì‹ë‹¨ ê³„íš ìˆ˜ë¦½ì— ìœ ìš©í•œ ì¸ì‚¬ì´íŠ¸ ì œê³µ
   - ê°œì„  ê°€ëŠ¥í•œ í•­ëª©ê³¼ ë¶ˆë³€ í•­ëª© êµ¬ë¶„
   - í˜„ì‹¤ì ì¸ ê°œì„  ê¸°ëŒ€ì¹˜ ì œì‹œ

5. **êµ¬ì²´ì  ìš´ë™/ì‹ë‹¨ ê³„íšì€ ì œì™¸**
   - "ìŠ¤ì¿¼íŠ¸ë¥¼ í•˜ì„¸ìš”", "ë‹­ê°€ìŠ´ì‚´ì„ ë“œì„¸ìš”" ê°™ì€ êµ¬ì²´ì  ì²˜ë°© X
   - "í•˜ì²´ ê·¼ë ¥ ê°•í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤", "ë‹¨ë°±ì§ˆ ì„­ì·¨ ì¦ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤" ê°™ì€ ë°©í–¥ì„±ë§Œ ì œì‹œ O

6. **ë…¼ë¬¸ í™œìš© ì‹œ ì£¼ì˜ì‚¬í•­ (InBody ë¶„ì„ íŠ¹í™”)**
   - ë…¼ë¬¸ì„ ë‹¨ìˆœ ë‚˜ì—´í•˜ì§€ ë§ ê²ƒ
   - **ì¸¡ì • ìˆ˜ì¹˜ì™€ ì§ì ‘ ì—°ê²°**: "ì²´ì§€ë°©ë¥  22%ëŠ” ì—°êµ¬ Xê°€ ì œì‹œí•œ ì ì • ë²”ìœ„ ë‚´ì´ë©°..."
   - **ê°œì„  ëª©í‘œì™€ ì—°ê³„**: "ê·¼ìœ¡ì¡°ì ˆ +2.5kgëŠ” ë…¼ë¬¸ Yì˜ 8ì£¼ í”„ë¡œê·¸ë¨ í‰ê·  ì¦ê°€ëŸ‰(+3.2kg)ê³¼ ë¹„êµí•˜ì—¬..."
   - **ë¶€ìœ„ë³„ ë¶„ì„ ì—°ê³„**: "ì™¼ë‹¤ë¦¬ ê·¼ìœ¡ë“±ê¸‰ 'í•˜'ëŠ” ë…¼ë¬¸ Zê°€ ì–¸ê¸‰í•œ ë¶ˆê· í˜• íŒ¨í„´ê³¼ ìœ ì‚¬í•˜ë©°..."
   - ë…¼ë¬¸ì˜ ëŒ€ìƒêµ°(ì„±ë³„, ì—°ë ¹, ì´ˆê¸° ì²´ì„±ë¶„)ê³¼ í˜„ì¬ ì‚¬ìš©ì ë¹„êµ
   - ê³¼í•™ì  ê·¼ê±° ê¸°ë°˜ìœ¼ë¡œ 3ê°œì›”/6ê°œì›” ê°œì„  ì˜ˆì¸¡ì¹˜ ì œì‹œ

ì´ ë¶„ì„ì€ ì‚¬ìš©ìê°€ ìì‹ ì˜ í˜„ì¬ ì²´ì„±ë¶„ ìƒíƒœë¥¼ ì •í™•íˆ ì´í•´í•˜ê³ ,
ê³¼í•™ì  ê·¼ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´í›„ ë§ì¶¤í˜• ìš´ë™/ì‹ë‹¨ ê³„íš ìˆ˜ë¦½ ì‹œ ì¤‘ìš”í•œ ê¸°ì¤€ì ì´ ë©ë‹ˆë‹¤.
"""

    # User prompt ìƒì„±
    user_prompt_parts = []

    user_prompt_parts.append("# InBody ì¸¡ì • ë°ì´í„°\n")

    # ê¸°ë³¸ ì •ë³´
    user_prompt_parts.append("## ê¸°ë³¸ ì •ë³´")
    user_prompt_parts.append(f"- ì„±ë³„: {measurements.ì„±ë³„}")
    user_prompt_parts.append(f"- ë‚˜ì´: {measurements.ë‚˜ì´}ì„¸")
    user_prompt_parts.append(f"- ì‹ ì¥: {measurements.ì‹ ì¥} cm")
    user_prompt_parts.append(f"- ì²´ì¤‘: {measurements.ì²´ì¤‘} kg")

    # ì²´ì„±ë¶„
    user_prompt_parts.append("\n## ì²´ì„±ë¶„ ë¶„ì„")
    user_prompt_parts.append(f"- BMI: {measurements.BMI}")
    user_prompt_parts.append(f"- ì²´ì§€ë°©ë¥ : {measurements.ì²´ì§€ë°©ë¥ }%")
    user_prompt_parts.append(f"- ê³¨ê²©ê·¼ëŸ‰: {measurements.ê³¨ê²©ê·¼ëŸ‰} kg")

    if measurements.ì²´ìˆ˜ë¶„:
        user_prompt_parts.append(f"- ì²´ìˆ˜ë¶„: {measurements.ì²´ìˆ˜ë¶„} L")
    if measurements.ë‹¨ë°±ì§ˆ:
        user_prompt_parts.append(f"- ë‹¨ë°±ì§ˆ: {measurements.ë‹¨ë°±ì§ˆ} kg")
    if measurements.ë¬´ê¸°ì§ˆ:
        user_prompt_parts.append(f"- ë¬´ê¸°ì§ˆ: {measurements.ë¬´ê¸°ì§ˆ} kg")
    if measurements.ì²´ì§€ë°©:
        user_prompt_parts.append(f"- ì²´ì§€ë°©ëŸ‰: {measurements.ì²´ì§€ë°©} kg")

    # ë¹„ë§Œ ì§€í‘œ
    user_prompt_parts.append("\n## ë¹„ë§Œ ì§€í‘œ")
    if measurements.ë³µë¶€ì§€ë°©ë¥ :
        user_prompt_parts.append(f"- ë³µë¶€ì§€ë°©ë¥ : {measurements.ë³µë¶€ì§€ë°©ë¥ }")
    if measurements.ë‚´ì¥ì§€ë°©ë ˆë²¨:
        user_prompt_parts.append(f"- ë‚´ì¥ì§€ë°©ë ˆë²¨: {measurements.ë‚´ì¥ì§€ë°©ë ˆë²¨}")
    if measurements.ë¹„ë§Œë„:
        user_prompt_parts.append(f"- ë¹„ë§Œë„: {measurements.ë¹„ë§Œë„}%")

    # ëŒ€ì‚¬
    user_prompt_parts.append("\n## ëŒ€ì‚¬ ì •ë³´")
    if measurements.ê¸°ì´ˆëŒ€ì‚¬ëŸ‰:
        user_prompt_parts.append(f"- ê¸°ì´ˆëŒ€ì‚¬ëŸ‰: {measurements.ê¸°ì´ˆëŒ€ì‚¬ëŸ‰} kcal")
    if measurements.ê¶Œì¥ì„­ì·¨ì—´ëŸ‰:
        user_prompt_parts.append(f"- ê¶Œì¥ ì„­ì·¨ ì—´ëŸ‰: {measurements.ê¶Œì¥ì„­ì·¨ì—´ëŸ‰} kcal")
    if measurements.ì ì •ì²´ì¤‘:
        user_prompt_parts.append(f"- ì ì • ì²´ì¤‘: {measurements.ì ì •ì²´ì¤‘} kg")

    # ì¡°ì ˆ ëª©í‘œ
    user_prompt_parts.append("\n## ì¡°ì ˆ ëª©í‘œ")
    if measurements.ì²´ì¤‘ì¡°ì ˆ:
        user_prompt_parts.append(f"- ì²´ì¤‘ ì¡°ì ˆ: {measurements.ì²´ì¤‘ì¡°ì ˆ:+.1f} kg")
    if measurements.ì§€ë°©ì¡°ì ˆ:
        user_prompt_parts.append(f"- ì§€ë°© ì¡°ì ˆ: {measurements.ì§€ë°©ì¡°ì ˆ:+.1f} kg")
    if measurements.ê·¼ìœ¡ì¡°ì ˆ:
        user_prompt_parts.append(f"- ê·¼ìœ¡ ì¡°ì ˆ: {measurements.ê·¼ìœ¡ì¡°ì ˆ:+.1f} kg")

    # ë¶€ìœ„ë³„ ê·¼ìœ¡
    user_prompt_parts.append("\n## ë¶€ìœ„ë³„ ê·¼ìœ¡ ë“±ê¸‰")
    for part, grade in measurements.ê·¼ìœ¡_ë¶€ìœ„ë³„ë“±ê¸‰.items():
        user_prompt_parts.append(f"- {part}: {grade}")

    # ë¶€ìœ„ë³„ ì²´ì§€ë°©
    if measurements.ì²´ì§€ë°©_ë¶€ìœ„ë³„ë“±ê¸‰:
        user_prompt_parts.append("\n## ë¶€ìœ„ë³„ ì²´ì§€ë°© ë“±ê¸‰")
        for part, grade in measurements.ì²´ì§€ë°©_ë¶€ìœ„ë³„ë“±ê¸‰.items():
            user_prompt_parts.append(f"- {part}: {grade}")

    # ì²´í˜• ë¶„ë¥˜ (ìˆëŠ” ê²½ìš°)
    if measurements.body_type1 or measurements.body_type2:
        user_prompt_parts.append("\n## ì²´í˜• ë¶„ë¥˜")
        if measurements.body_type1:
            user_prompt_parts.append(f"- Body Type 1: {measurements.body_type1}")
        if measurements.body_type2:
            user_prompt_parts.append(f"- Body Type 2: {measurements.body_type2}")

    user_prompt = "\n".join(user_prompt_parts)

    # Graph RAG ë…¼ë¬¸ ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
    if paper_context:
        user_prompt += "\n\n" + _format_paper_context(paper_context)

    return system_prompt, user_prompt


def _format_paper_context(papers: List[dict]) -> str:
    """
    ë…¼ë¬¸ ì»¨í…ìŠ¤íŠ¸ë¥¼ í”„ë¡¬í”„íŠ¸ í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ… (InBody ë¶„ì„ìš©)

    Args:
        papers: ë…¼ë¬¸ ë¦¬ìŠ¤íŠ¸

    Returns:
        í¬ë§·ëœ ë¬¸ìì—´
    """
    formatted_text = "## ğŸ“š ê³¼í•™ì  ê·¼ê±° (ìµœì‹  ì—°êµ¬ ë…¼ë¬¸)\n\n"
    formatted_text += "**ë‹¤ìŒ ë…¼ë¬¸ë“¤ì„ ì°¸ê³ í•˜ì—¬ í˜„ì¬ ì²´ì„±ë¶„ ìƒíƒœë¥¼ ë¶„ì„í•˜ê³  ê°œì„  ë°©í–¥ì„ ì œì‹œí•˜ì„¸ìš”:**\n\n"

    for i, paper in enumerate(papers, 1):
        title = paper.get("title", "N/A")
        chunk_text = paper.get("chunk_text", "")
        chunk_ko_summary = paper.get("chunk_ko_summary", "")
        year = paper.get("year", "N/A")
        source = paper.get("source", "N/A")
        final_score = paper.get("final_score", 0.0)

        # í•œêµ­ì–´ ìš”ì•½ì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë¬¸ ì¼ë¶€ ì‚¬ìš©
        content = chunk_ko_summary if chunk_ko_summary else chunk_text[:400]

        formatted_text += f"""### ë…¼ë¬¸ {i}: {title}
- ì¶œì²˜: {source} ({year})
- ê´€ë ¨ë„: {final_score:.2f}
- í•µì‹¬ ë‚´ìš©: {content}

"""

    formatted_text += "\n**ë¶„ì„ ì‹œ ì£¼ì˜ì‚¬í•­:**\n"
    formatted_text += "- ìœ„ ë…¼ë¬¸ì˜ ë‚´ìš©ì„ InBody ì¸¡ì • ìˆ˜ì¹˜(ì²´ì§€ë°©ë¥ , ê³¨ê²©ê·¼ëŸ‰, ë‚´ì¥ì§€ë°© ë“±)ì™€ ì§ì ‘ ì—°ê²°í•˜ì„¸ìš”\n"
    formatted_text += "- ë…¼ë¬¸ì—ì„œ ì œì‹œí•œ ìˆ˜ì¹˜ë‚˜ íš¨ê³¼ë¥¼ í˜„ì¬ ì¸¡ì •ê°’ê³¼ ë¹„êµí•˜ì—¬ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”\n"
    formatted_text += "- ë…¼ë¬¸ì˜ ì—°êµ¬ ëŒ€ìƒ, ë°©ë²•ë¡ ì´ í˜„ì¬ ì‚¬ìš©ìì—ê²Œ ì ìš© ê°€ëŠ¥í•œì§€ í‰ê°€í•˜ì„¸ìš”\n"
    formatted_text += "- ê³¼í•™ì  ê·¼ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í˜„ì‹¤ì ì¸ ê°œì„  ëª©í‘œì™€ ê¸°ëŒ€ íš¨ê³¼ë¥¼ ì œì‹œí•˜ì„¸ìš”\n"

    return formatted_text
