"""
주간 계획 생성 로직
"""

from typing import List
from datetime import datetime, timedelta

from shared.models import UserGoal, UserPreferences, WeeklyPlan
from shared.llm_clients import BaseLLMClient
from shared.database import Database

from pipeline_weekly_plan.rag_retriever import InBodyRAGRetriever
from pipeline_weekly_plan.prompt_generator import create_weekly_plan_prompt


class WeeklyPlanner:
    """주간 운동/식단 계획 생성기"""

    def __init__(
        self, db: Database, llm_client: BaseLLMClient, model_version: str, use_ollama_rag: bool = False
    ):
        """
        Args:
            db: Database 인스턴스
            llm_client: LLM 클라이언트
            model_version: 모델 버전
            use_ollama_rag: RAG에서 Ollama bge-m3 사용 여부
        """
        self.db = db
        self.llm_client = llm_client
        self.model_version = model_version
        self.rag_retriever = InBodyRAGRetriever(db, use_ollama=use_ollama_rag)

    def generate_plan(
        self,
        user_id: int,
        goals: List[UserGoal],
        preferences: UserPreferences,
        week_number: int = 1,
        start_date: str = None,
    ) -> WeeklyPlan:
        """
        주간 계획 생성

        Args:
            user_id: 사용자 ID
            goals: 사용자 목표 리스트
            preferences: 사용자 선호도
            week_number: 주차
            start_date: 시작 날짜 (YYYY-MM-DD)

        Returns:
            WeeklyPlan
        """
        print("=" * 60)
        print(f"주간 계획 생성 시작 (User ID: {user_id}, Week {week_number})")
        print("=" * 60)

        # 1단계: InBody 분석 결과 검색 (RAG)
        print("\n🔍 1단계: InBody 분석 결과 검색...")
        inbody_context = self.rag_retriever.retrieve_similar_analyses(
            user_id=user_id, query="체형 분석", top_k=6
        )

        if not inbody_context:
            print("  ⚠️  InBody 분석 결과가 없습니다. 일반적인 계획을 생성합니다.")

        # 2단계: 날짜 계산
        if not start_date:
            # 다음 주 월요일
            today = datetime.now()
            days_until_monday = (7 - today.weekday()) % 7
            if days_until_monday == 0:
                days_until_monday = 7
            next_monday = today + timedelta(days=days_until_monday)
            start_date = next_monday.strftime("%Y-%m-%d")

        start = datetime.strptime(start_date, "%Y-%m-%d")
        end = start + timedelta(days=6)
        end_date = end.strftime("%Y-%m-%d")

        print(f"  ✓ 기간: {start_date} ~ {end_date}")

        # 3단계: 프롬프트 생성
        print("\n📝 2단계: 프롬프트 생성...")
        system_prompt, user_prompt = create_weekly_plan_prompt(
            user_goals=goals,
            user_preferences=preferences,
            inbody_context=inbody_context,
            week_number=week_number,
            start_date=start_date,
        )

        # 4단계: LLM 호출
        print("\n🤖 3단계: LLM 주간 계획 생성...")
        print("  - LLM 호출 중...")
        llm_output = self.llm_client.generate_chat(system_prompt, user_prompt)

        print(f"  ✓ 계획 생성 완료 ({len(llm_output)} 글자)")

        # 5단계: WeeklyPlan 모델 생성 (자연어 출력 사용)
        print("\n📊 4단계: 계획 저장 준비...")
        weekly_plan = WeeklyPlan(
            user_id=user_id,
            week_number=week_number,
            start_date=start_date,
            end_date=end_date,
            weekly_summary="",
            weekly_goal="",
            tips=[],
            daily_plans=[],
            model_version=self.model_version,
            llm_raw_output=llm_output,  # LLM 원본 자연어 출력
        )

        print(f"  ✓ 자연어 계획 생성 완료")

        print("\n" + "=" * 60)
        print("✨ 주간 계획 생성 완료!")
        print("=" * 60)

        return weekly_plan

    def save_plan_to_db(self, weekly_plan: WeeklyPlan) -> tuple[int, str]:
        """
        주간 계획을 DB에 저장 (SQLAlchemy)

        Args:
            weekly_plan: 주간 계획

        Returns:
            (plan_id, refined_text)
        """
        print("\n💾 주간 계획 저장...")

        try:
            # datetime.date 객체로 변환
            from datetime import datetime

            start_date_obj = datetime.strptime(
                weekly_plan.start_date, "%Y-%m-%d"
            ).date()
            end_date_obj = datetime.strptime(weekly_plan.end_date, "%Y-%m-%d").date()

            # DB에 저장 (SQLAlchemy)
            # mode='json'을 사용하여 datetime을 문자열로 직렬화
            plan_id = self.db.save_weekly_plan(
                user_id=weekly_plan.user_id,
                week_number=weekly_plan.week_number,
                start_date=start_date_obj,
                end_date=end_date_obj,
                plan_data=weekly_plan.model_dump(mode='json'),
                model_version=weekly_plan.model_version,
            )

            print(f"  ✓ DB 저장 완료 (Plan ID: {plan_id})")

            # 2차 LLM 정제 (사용자 친화적 요약)
            print("\n✨ 사용자 친화적 요약 생성...")
            refined_system_prompt = """당신은 15년 경력의 피트니스 코치이자 영양사이며, 동시에 프리미엄 헬스케어 리포트 디자이너입니다. 
아래 주간 운동/식단 계획을 바쁜 직장인/학생이 **스마트폰으로 보면서 바로 실천할 수 있도록** 
시각적이고 직관적이며 동기부여 넘치는 Markdown 문서로 재구성해주세요.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📐 출력 형식: MARKDOWN (.md) 필수!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

이 문서는 반드시 Markdown 문법을 최대한 활용해야 합니다:
- 표(table)를 적극 활용
- 체크박스 리스트 활용
- 볼드(**), 이탤릭(*), 취소선(~~) 활용
- 헤더(#, ##, ###) 계층 구조
- 인용구(>), 코드블록(```) 적절히 활용
- 이모지로 시각적 구분

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 출력 구조 (반드시 이 순서로 작성)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🏃‍♂️ 주차별 운동/식단 계획

> **계획 기간**: [시작일] ~ [종료일]  
> **이번 주 핵심 목표**: [한 문장으로 요약]  
> **체중 목표**: [현재 → 목표]  
> **예상 감량**: [X]kg ⬇️

---

## 📊 1️⃣ 이번 주 한눈에 보기

### 🎯 주간 목표 대시보드

| 목표 항목 | 현재 상태 | 이번 주 목표 | 달성 전략 | 우선순위 |
|----------|---------|------------|---------|---------|
| **체중** | [X]kg | [Y]kg ⬇️[Z]kg | 유산소 3회 + 식단 조절 | 🔴 높음 |
| **체지방률** | [X]% | [Y]% ⬇️[Z]% | HIIT + 저탄수 식단 | 🔴 높음 |
| **복부둘레** | [X]cm | [Y]cm ⬇️[Z]cm | 코어 운동 매일 | 🟡 중간 |
| **근육량** | [X]kg | [Y]kg ⬆️[Z]kg | 단백질 섭취 증가 | 🟢 유지 |

### 📅 주간 스케줄 미리보기
```
월 💪 상체 근력 (60분) + 고단백 식단
화 🏃 유산소 달리기 (60분) + 탄수화물 조절
수 🦵 하체 근력 (60분) + 균형 식단
목 🧘 휴식/스트레칭 (30분) + 가벼운 식사
금 🔥 복부 집중 (60분) + 저염 식단
토 🚴 유산소 자전거 (60분) + 치팅밀 가능
일 😴 완전 휴식 + 식단 복기
```

### ✅ 이번 주 반드시 지킬 3가지

- [ ] **물 2L 이상** 매일 섭취 (아침 500ml, 점심 500ml, 저녁 500ml, 운동 중 500ml)
- [ ] **운동 전후 스트레칭 필수** (부상 예방이 최우선!)
- [ ] **매일 체중 기록** (아침 공복 시 측정 → 앱에 기록)

---

## 💪 2️⃣ 주간 운동 상세 계획

### 🗓️ 월요일: 상체 근력 운동

> **장소**: 헬스장  
> **총 소요 시간**: 60분  
> **목표 칼로리 소모**: ~400kcal  
> **핵심 타겟**: 가슴, 어깨, 삼두  

#### ⏰ 타임라인

| 시간 | 단계 | 내용 | 중요도 |
|-----|------|------|-------|
| 0-10분 | 🔥 워밍업 | 팔 돌리기, 가벼운 푸시업 | ⭐⭐⭐ |
| 10-45분 | 💪 메인 운동 | 벤치프레스, 숄더프레스 | ⭐⭐⭐⭐⭐ |
| 45-50분 | 😌 쿨다운 | 스트레칭, 가슴/어깨 | ⭐⭐⭐⭐ |
| 50-60분 | 🚶 정리 | 가벼운 걷기, 심박수 안정화 | ⭐⭐⭐ |

#### 🏋️ 메인 운동 상세

##### 1. 벤치 프레스

| 항목 | 내용 |
|-----|------|
| **세트/횟수** | 3세트 × 8-10회 |
| **휴식 시간** | 90초 |
| **목표 무게** | [체중의 60-80%] |
| **시작 자세** | 벤치에 누워 발은 바닥에 고정, 바를 어깨너비로 잡기 |
| **동작 수행** | 천천히 가슴까지 내린 후 빠르게 밀어 올리기 |
| **호흡법** | ⬇️ 내릴 때 들이마시기 / ⬆️ 올릴 때 내쉬기 |
| **주의사항** | ⚠️ 어깨가 벤치에서 떨어지면 안됨! ⚠️ 손목 각도 주의! |
| **실패 시 대안** | 덤벨 프레스로 대체 (무게 50% 감소) |

##### 2. 덤벨 숄더 프레스

| 항목 | 내용 |
|-----|------|
| **세트/횟수** | 3세트 × 10-12회 |
| **휴식 시간** | 60초 |
| **시작 자세** | 양손 덤벨, 어깨 높이에서 시작 |
| **호흡법** | ⬆️ 올릴 때 내쉬기 |
| **주의사항** | ⚠️ 허리 과도하게 굽지 말기! 코어에 힘 주기! |
| **강도 조절** | 💡 힘들면 앉아서 수행 가능 |

#### ✅ 월요일 체크리스트

- [ ] 워밍업 10분 완료
- [ ] 벤치프레스 3세트 완료 (무게: ___kg)
- [ ] 숄더프레스 3세트 완료 (무게: ___kg)
- [ ] 쿨다운 스트레칭 10분 완료
- [ ] 운동 직후 단백질 섭취 (프로틴 쉐이크 or 닭가슴살)

---

## 🍽️ 3️⃣ 주간 식단 상세 계획

### 📊 하루 목표 칼로리 & 영양소 배분

| 영양소 | 목표량 | 비율 | 주요 급원 |
|-------|--------|------|---------|
| **총 칼로리** | 1,800-2,000 kcal | 100% | - |
| **단백질** | 120-140g | 25-30% | 닭가슴살, 계란, 두부, 프로틴 |
| **탄수화물** | 180-200g | 40-45% | 현미, 고구마, 오트밀 |
| **지방** | 50-60g | 25-30% | 올리브유, 아보카도, 견과류 |

### 🥗 월요일 식단

#### 🌅 아침 (7:00 AM) - 350kcal

**메뉴: 계란 토스트 with 샐러드**

| 재료 | 수량 | 단백질 | 탄수화물 | 지방 |
|-----|------|-------|---------|------|
| 계란 | 2개 | 12g | 1g | 10g |
| 통곡물 식빵 | 1장 | 4g | 25g | 1g |
| 시금치 | 1줌 | 2g | 2g | 0g |
| 방울토마토 | 4개 | 1g | 4g | 0g |
| 올리브유 | 1티스푼 | 0g | 0g | 5g |

**조리법**:
1. 🍳 계란을 스크램블하여 소금, 후추로 간합니다 (약 5분)
2. 🍞 통곡물 식빵을 토스터에 구워줍니다 (2분)
3. 🥗 시금치와 방울토마토를 씻어 샐러드를 준비합니다
4. 📌 계란을 식빵 위에 올리고, 샐러드를 곁들입니다

**조리 시간**: ⏱️ 10분  
**난이도**: ⭐ (초보자 가능)  
**보관법**: 당일 섭취 권장  

#### 🌞 점심 (12:30 PM) - 500kcal

**메뉴: 닭가슴살 샐러드**

| 재료 | 수량 | 단백질 | 탄수화물 | 지방 | 칼로리 |
|-----|------|-------|---------|------|--------|
| 닭가슴살 | 150g | 35g | 0g | 3g | 165kcal |
| 혼합 샐러드 | 1봉지 | 3g | 15g | 1g | 80kcal |
| 방울토마토 | 10개 | 2g | 8g | 0g | 40kcal |
| 올리브유 | 1스푼 | 0g | 0g | 14g | 120kcal |
| 발사믹 식초 | 2스푼 | 0g | 6g | 0g | 25kcal |
| 아보카도 | 1/4개 | 1g | 3g | 8g | 80kcal |

**조리법**:
1. 🔥 닭가슴살에 소금, 후추로 간하고 팬에 구워줍니다 (12분)
2. ❄️ 구운 닭가슴살을 식혀줍니다 (5분)
3. 🥗 샐러드 채소를 깨끗이 씻어 물기를 제거합니다
4. 🔪 닭가슴살을 한 입 크기로 썰어줍니다
5. 🥑 아보카도를 슬라이스합니다
6. 🍴 모든 재료를 그릇에 담고 드레싱을 뿌립니다

**조리 시간**: ⏱️ 20분  
**난이도**: ⭐⭐ (중급)  
**보관법**: 냉장 보관 1일 가능 (드레싱은 따로)  

**💡 도시락 팁**: 
- 닭가슴살과 샐러드는 따로 담기
- 드레싱은 작은 용기에 별도 보관
- 점심 직전에 섞어서 먹기

#### 🌙 저녁 (7:00 PM) - 550kcal

**메뉴: 현미밥과 된장찌개**

| 재료 | 수량 | 단백질 | 탄수화물 | 지방 |
|-----|------|-------|---------|------|
| 현미밥 | 1공기 (210g) | 5g | 70g | 2g |
| 두부 | 100g | 10g | 2g | 5g |
| 애호박 | 50g | 1g | 3g | 0g |
| 양파 | 1/4개 | 0.5g | 4g | 0g |
| 된장 | 1스푼 | 2g | 3g | 1g |

**조리법**:
1. 💧 냄비에 물 500ml를 끓입니다
2. 🔪 애호박, 양파를 한 입 크기로 썰어줍니다
3. 🧊 두부를 큐브 모양으로 잘라줍니다
4. 🥄 끓는 물에 된장을 풀어줍니다
5. 🥬 야채를 넣고 5분간 끓입니다
6. 🍲 마지막에 두부를 넣고 한소끔 더 끓입니다

**조리 시간**: ⏱️ 20분  
**난이도**: ⭐ (초보자 가능)  
**보관법**: 냉장 보관 2일 가능  

---

---

### 📊 식단 준수 팁

#### 🛒 주간 장보기 리스트

**단백질 (냉장/냉동)**
- [ ] 닭가슴살 1kg
- [ ] 연어 300g
- [ ] 두부 3모
- [ ] 계란 30개 (1판)
- [ ] 그릭 요거트 400g

**탄수화물**
- [ ] 현미 2kg
- [ ] 통곡물 식빵 1봉지
- [ ] 고구마 1kg
- [ ] 오트밀 500g

**채소/과일**
- [ ] 시금치 2봉지
- [ ] 혼합 샐러드 3봉지
- [ ] 브로콜리 3송이
- [ ] 방울토마토 1팩
- [ ] 바나나 7개
- [ ] 블루베리 1팩

**기타**
- [ ] 올리브유
- [ ] 발사믹 식초
- [ ] 된장
- [ ] 고추장
- [ ] 프로틴 파우더

#### 💰 예상 식비

| 항목 | 금액 | 비고 |
|-----|------|------|
| 단백질 | 50,000원 | 닭가슴살, 연어, 계란 등 |
| 탄수화물 | 20,000원 | 현미, 빵, 고구마 등 |
| 채소/과일 | 30,000원 | 샐러드, 과일 등 |
| 조미료/기타 | 15,000원 | 올리브유, 프로틴 등 |
| **총합** | **115,000원** | 1인 1주일 기준 |

#### 🍱 도시락 준비 팁

**일요일 배치 쿠킹 (2시간)**
1. 닭가슴살 1kg 한 번에 구워서 소분 냉동
2. 고구마 10개 쪄서 냉장 보관
3. 브로콜리 삶아서 소분 보관
4. 현미밥 7공기 지어서 소분 냉동
5. 계란 10개 삶아서 냉장 보관

**💡 이렇게 하면 평일에 10분이면 도시락 완성!**

---

## 📈 4️⃣ 주간 진행 상황 트래킹

### 📊 일일 체크리스트

매일 저녁 10시에 아래 항목을 체크하세요!

| 날짜 | 체중 | 운동 완료 | 식단 준수 | 물 2L | 수면 7시간 | 스트레칭 |
|-----|------|---------|---------|-------|-----------|---------|
| 월 (2/2) | ___kg | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| 화 (2/3) | ___kg | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| 수 (2/4) | ___kg | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| 목 (2/5) | ___kg | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| 금 (2/6) | ___kg | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| 토 (2/7) | ___kg | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| 일 (2/8) | ___kg | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |

### 📸 주간 진행 사진 기록

| 각도 | 월요일 (시작) | 금요일 (중간) | 일요일 (종료) |
|-----|----------|----------|----------|
| **정면** | 📸 | 📸 | 📸 |
| **측면** | 📸 | 📸 | 📸 |
| **후면** | 📸 | 📸 | 📸 |

**💡 사진 촬영 팁**:
- ⏰ 매주 같은 시간 (아침 공복)
- 👕 같은 옷 착용 (몸 라인이 보이는 옷)
- 📍 같은 장소, 같은 조명
- 📏 거울에서 같은 거리

### 📉 주간 변화 예상 그래프
```
체중 변화 (kg)
78.0 ┤ ●
     │  ╲
77.5 ┤   ●
     │    ╲
77.0 ┤     ●
     │      ╲
76.5 ┤       ●───● 목표
     │
     └─────────────────
      월  화 수  목 금 토 일
```

### 🎯 주간 목표 달성률

| 목표 항목 | 목표 | 현재 | 달성률 | 상태 |
|---------|------|------|-------|------|
| 체중 감량 | -1.0kg | ___kg | __% | 🟢🟡🔴 |
| 운동 횟수 | 6회 | __회 | __% | 🟢🟡🔴 |
| 식단 준수 | 90% | __% | __% | 🟢🟡🔴 |
| 물 섭취 | 14L | __L | __% | 🟢🟡🔴 |

---

## 💡 5️⃣ 성공을 위한 필수 팁

### 🧠 멘탈 관리

#### 동기부여 문구 (매일 아침 읽기!)

> 💪 "완벽하지 않아도 괜찮아. 어제보다 1%만 나아지면 돼."
> 
> 🔥 "3개월 후의 내 몸은 오늘 내가 한 선택으로 만들어진다."
> 
> 💯 "힘들 때마다 목표를 상기하자. 왜 시작했는지 기억하자."

#### 슬럼프 극복 전략

| 상황 | 해결책 |
|-----|--------|
| 😩 운동 가기 싫을 때 | ✅ "5분만 하자" 정신 → 시작하면 30분은 함 |
| 🍕 폭식 충동 | ✅ 물 500ml 마시고 10분 기다리기 |
| 😫 체중 정체기 | ✅ 사진 비교로 변화 확인 (체중이 아닌 몸매!) |
| 😴 피곤해서 못하겠을 때 | ✅ 휴식도 계획의 일부! 내일 더 열심히 |

### ⚠️ 주의사항

#### 🚨 즉시 운동 중단해야 할 신호

- 💔 가슴 통증 또는 호흡 곤란
- 🤢 극심한 어지러움이나 구토
- 💥 관절에서 "뚝" 소리와 함께 통증
- 🔥 근육 경련이 10분 이상 지속
- 🩸 시야가 흐려지거나 의식이 흐릿해짐

**→ 이런 증상이 있으면 즉시 전문의 상담!**

#### ✅ 안전한 운동을 위한 체크리스트

- [ ] 운동 30분 전 가벼운 식사 (바나나, 에너지바 등)
- [ ] 충분한 워밍업 (최소 5-10분)
- [ ] 적절한 운동복과 신발 착용
- [ ] 물통 준비 (500ml 이상)
- [ ] 응급 연락처 저장
- [ ] 헬스장 응급 키트 위치 파악

### 📱 추천 앱 & 도구

| 카테고리 | 추천 앱/도구 | 용도 |
|---------|-----------|------|
| 🏃 운동 기록 | Strava, Nike Run Club | 러닝 거리/페이스 트래킹 |
| 💪 근력 운동 | Strong, JEFIT | 세트/무게 기록 |
| 🍽️ 식단 관리 | MyFitnessPal, 눔 | 칼로리/영양소 계산 |
| ⚖️ 체중 관리 | Happy Scale, Libra | 체중 트렌드 분석 |
| 💧 물 섭취 | WaterMinder, Plant Nanny | 수분 섭취 알림 |
| 😴 수면 추적 | Sleep Cycle, 삼성 헬스 | 수면 패턴 분석 |

### 🎓 운동 용어 사전

| 용어 | 뜻 | 예시 |
|-----|-----|------|
| **1RM** | 1회 최대 반복 무게 | 벤치프레스 1RM이 80kg = 한 번만 들 수 있는 무게 |
| **RPE** | 자각 운동 강도 (1-10) | RPE 7 = 10점 중 7 정도로 힘듦 |
| **세트** | 운동 묶음 단위 | 3세트 × 10회 = 10회씩 3번 반복 |
| **슈퍼세트** | 두 운동을 쉬지 않고 연속 | 푸시업 10회 → 바로 풀업 10회 |
| **드롭세트** | 무게를 줄여가며 반복 | 50kg → 40kg → 30kg 계속 수행 |
| **HIIT** | 고강도 인터벌 트레이닝 | 전력질주 30초 + 걷기 1분 반복 |
| **LISS** | 저강도 유산소 | 50분 천천히 조깅 |

---

## 🎉 6️⃣ 일주일 후 체크포인트

### ✅ 1주차 완료 후 해야 할 것

1. **📊 결과 측정**
   - [ ] 체중 측정 및 기록
   - [ ] 체지방률 측정 (가능 시)
   - [ ] 사진 촬영 (정면/측면/후면)
   - [ ] 복부 둘레 측정

2. **🤔 회고 (Retrospective)**
   - [ ] 가장 힘들었던 운동은?
   - [ ] 가장 맛있었던 식단은?
   - [ ] 예상보다 쉬웠던 부분은?
   - [ ] 다음 주에 개선할 점은?

3. **📝 다음 주 계획 조정**
   - [ ] 운동 강도 5-10% 증가
   - [ ] 힘들었던 식단 메뉴 변경
   - [ ] 새로운 운동 1-2개 추가
   - [ ] 휴식일 재조정 (필요 시)

### 🏆 보상 시스템

| 달성 항목 | 보상 |
|---------|------|
| 🎯 100% 운동 완료 | 새 운동복 or 운동화 구매 |
| 🥗 90% 이상 식단 준수 | 토요일 치팅밀 업그레이드 (고급 레스토랑) |
| ⚖️ 목표 체중 달성 | 마사지 or 스파 이용 |
| 💧 매일 물 2L 달성 | 좋아하는 영화 보기 or 게임 2시간 |

### 📞 도움이 필요할 때

**무료 상담 가능한 곳**
- 🏥 보건소 영양 상담 (무료)
- 📱 다이어트 앱 커뮤니티
- 🏃 러닝 크루 (지역별 모임)
- 💬 온라인 피트니스 커뮤니티 (클리앙, 보배드림 등)

**전문가 상담이 필요한 경우**
- 💔 만성 질환이 있는 경우 (당뇨, 고혈압 등)
- 🤕 과거 부상 이력이 있는 경우
- 💊 약물 복용 중인 경우
- 🤰 임신 중이거나 수유 중인 경우

---

## 📌 마지막 당부

> ### 🎯 기억하세요!
> 
> 1. **완벽보다는 일관성**  
>    하루 빠뜨려도 괜찮아요. 다음 날 다시 시작하면 됩니다.
> 
> 2. **몸의 신호 경청**  
>    아프면 쉬세요. 근성으로 운동하다 다치면 더 오래 쉬어야 합니다.
> 
> 3. **비교는 과거의 나와만**  
>    남과 비교하지 마세요. 어제의 나보다 나아지면 됩니다.
> 
> 4. **즐기면서 하기**  
>    고통스러운 다이어트는 오래 못 갑니다. 재미를 찾으세요!
> 
> 5. **목표를 잊지 말기**  
>    왜 시작했는지 항상 상기하세요. 동기부여가 핵심입니다.

---

## 🔥 시작이 반입니다!

**첫 주가 가장 어렵습니다. 하지만 2주만 버티면 습관이 됩니다!**

- ✅ 월요일 아침, 알람을 맞춰두세요
- ✅ 오늘 밤, 운동복을 미리 꺼내두세요
- ✅ 지금 바로, 냉장고를 정리하고 장보기 리스트를 작성하세요

**당신은 할 수 있습니다! 화이팅! 💪🔥**

---

**📅 생성일**: [날짜]  
**📝 버전**: 1.0  
**✍️ 작성자**: AI 피트니스 코치  
**📧 문의**: [연락처 또는 커뮤니티 링크]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
© 2026 주간 운동/식단 계획 v1.0 | 건강한 변화의 시작! 🌟
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```
"""


# ### 🗓️ 화요일: 유산소 운동 (러닝)

# > **장소**: 헬스장 또는 야외  
# > **총 소요 시간**: 60분  
# > **목표 칼로리 소모**: ~500kcal  
# > **핵심 효과**: 체지방 감소, 심폐지구력 향상  

# #### 🏃 인터벌 러닝 프로토콜

# | 구간 | 시간 | 속도 | 심박수 목표 | 체감 강도 |
# |-----|------|------|-----------|---------|
# | 워밍업 | 5분 | 4-5 km/h | 60-70% | 😊 매우 편함 |
# | 메인 1 | 5분 | 6-7 km/h | 70-80% | 🙂 조금 힘듦 |
# | 스프린트 | 1분 | 8-9 km/h | 80-90% | 😅 많이 힘듦 |
# | 회복 | 4분 | 5-6 km/h | 65-75% | 🙂 조금 편함 |
# | *반복* | 40분 | *위 패턴 반복* | - | - |
# | 쿨다운 | 5분 | 4 km/h | 60% 이하 | 😌 매우 편함 |

# #### 💡 러닝 팁

# > **호흡법**: 2-2 리듬 (2보 들이마시기, 2보 내쉬기)  
# > **자세**: 상체는 곧게, 팔은 90도 각도 유지  
# > **음악 추천**: BPM 140-160 (빠른 템포)  

# #### ✅ 화요일 체크리스트

# - [ ] 러닝화 착용 (쿠션 좋은 신발!)
# - [ ] 워밍업 5분 완료
# - [ ] 인터벌 40분 완료 (총 거리: ___km)
# - [ ] 쿨다운 5분 완료
# - [ ] 운동 후 스트레칭 10분
# - [ ] 수분 섭취 500ml 이상

# ---

# ### 🗓️ 수요일: 하체 근력 운동

# > **장소**: 헬스장  
# > **총 소요 시간**: 60분  
# > **목표 칼로리 소모**: ~450kcal  
# > **핵심 타겟**: 대퇴사두근, 햄스트링, 둔근  

# #### 🦵 메인 운동 상세

# ##### 1. 바벨 스쿼트 (하체의 왕!)

# | 항목 | 내용 |
# |-----|------|
# | **세트/횟수** | 3세트 × 10-12회 |
# | **휴식 시간** | 90초 (충분한 회복 중요!) |
# | **목표 무게** | [체중의 50-70%] |
# | **시작 자세** | 발 어깨너비, 발끝 약간 바깥 |
# | **동작 수행** | 무릎 구부리며 앉듯이 내려가기 (허벅지가 바닥과 평행) |
# | **호흡법** | ⬇️ 내려갈 때 들이마시기 / ⬆️ 올라올 때 내쉬기 |
# | **주의사항** | ⚠️⚠️⚠️ 무릎이 발끝보다 앞으로 나가면 안됨! ⚠️⚠️⚠️ |
# | **폼 체크** | 거울로 측면 확인, 무릎-발끝 일직선 유지 |

# ##### 2. 레그 프레스

# | 항목 | 내용 |
# |-----|------|
# | **세트/횟수** | 3세트 × 10-12회 |
# | **휴식 시간** | 60초 |
# | **발 위치** | 플랫폼 중앙, 어깨너비 |
# | **주의사항** | ⚠️ 허리가 의자에서 떨어지면 안됨! |
# | **강도 조절** | 발 위치로 조절 (높이 → 둔근, 낮게 → 대퇴사두근) |

# #### ✅ 수요일 체크리스트

# - [ ] 무릎 보호대 착용 (선택)
# - [ ] 워밍업 스쿼트 10회 × 2세트
# - [ ] 바벨 스쿼트 3세트 완료 (무게: ___kg)
# - [ ] 레그 프레스 3세트 완료 (무게: ___kg)
# - [ ] 하체 스트레칭 10분 (특히 햄스트링!)
# - [ ] 운동 후 단백질 섭취

# ---

# ### 🗓️ 목요일: 적극적 휴식 (Active Recovery)

# > **장소**: 집 또는 공원  
# > **총 소요 시간**: 30-45분  
# > **목표**: 근육 회복, 유연성 향상  

# #### 🧘 추천 활동

# | 활동 | 시간 | 효과 | 난이도 |
# |-----|------|------|-------|
# | 가벼운 산책 | 20분 | 혈액 순환 ↑ | ⭐ |
# | 전신 스트레칭 | 15분 | 근육통 완화 | ⭐⭐ |
# | 요가 (초급) | 30분 | 유연성 ↑ | ⭐⭐ |
# | 폼롤러 | 10분 | 근막 이완 | ⭐⭐⭐ |

# #### 💡 휴식일이라고 방심 금지!

# > ⚠️ **주의**: "휴식"은 "아무것도 안 함"이 아닙니다!  
# > ✅ 적극적으로 회복하면 다음 운동 퍼포먼스가 20% 향상됩니다.

# #### ✅ 목요일 체크리스트

# - [ ] 가벼운 활동 20분 이상
# - [ ] 스트레칭 15분 (특히 어제 운동한 부위)
# - [ ] 물 2L 섭취 달성
# - [ ] 수면 시간 확인 (7-8시간 목표)
# - [ ] 다음날 운동복 준비

# ---

# ### 🗓️ 금요일: 복부 & 코어 집중 훈련

# > **장소**: 헬스장 또는 집  
# > **총 소요 시간**: 60분  
# > **목표 칼로리 소모**: ~350kcal  
# > **핵심 타겟**: 복직근, 복사근, 코어 전체  

# #### 🔥 코어 서킷 트레이닝 (3라운드)

# 각 운동을 쉬지 않고 연속으로 수행 → 1라운드 종료 후 2분 휴식

# | 순서 | 운동명 | 시간/횟수 | 타겟 부위 | 난이도 |
# |-----|-------|---------|---------|-------|
# | 1 | 플랭크 | 60초 유지 | 코어 전체 | ⭐⭐⭐ |
# | 2 | 러시안 트위스트 | 15회 (양쪽) | 복사근 | ⭐⭐⭐⭐ |
# | 3 | 바이시클 크런치 | 20회 | 복직근 | ⭐⭐⭐ |
# | 4 | 레그레이즈 | 12회 | 하복부 | ⭐⭐⭐⭐ |
# | 5 | 마운틴 클라이머 | 30초 | 코어 + 유산소 | ⭐⭐⭐⭐ |

# #### 💡 플랭크 자세 완벽 가이드
# ```
# [올바른 자세]
#   팔꿈치는 어깨 바로 아래
#          ⬇️
#     머리-등-엉덩이-발 일직선
    
# [틀린 자세]
# ❌ 엉덩이가 너무 올라감
# ❌ 허리가 꺾임
# ❌ 고개를 들어 목에 힘이 들어감
# ```

# #### ✅ 금요일 체크리스트

# - [ ] 워밍업 크런치 10회 × 2세트
# - [ ] 서킷 1라운드 완료
# - [ ] 서킷 2라운드 완료
# - [ ] 서킷 3라운드 완료
# - [ ] 복부 스트레칭 10분 (코브라 자세 등)
# - [ ] 복부 사진 찍기 (진행 상황 기록)

# ---

# ### 🗓️ 토요일: 유산소 운동 (자전거/수영)

# > **장소**: 헬스장, 야외, 수영장  
# > **총 소요 시간**: 60분  
# > **목표 칼로리 소모**: ~550kcal  
# > **핵심 효과**: 지방 연소, 전신 지구력  

# #### 🚴 자전거 프로그램

# | 구간 | 시간 | 강도 (RPM) | 저항 | 심박수 목표 |
# |-----|------|----------|------|-----------|
# | 워밍업 | 5분 | 60-70 | 낮음 | 60-70% |
# | 메인 | 45분 | 80-100 | 중간 | 70-85% |
# | 스프린트 | 5분 × 2 | 110-120 | 중간 | 85-90% |
# | 쿨다운 | 5분 | 50-60 | 낮음 | 60% 이하 |

# #### 🏊 수영 프로그램 (대안)

# | 영법 | 거리 | 세트 | 휴식 | 칼로리 |
# |-----|------|------|------|-------|
# | 자유형 | 50m | 10회 | 30초 | ~300kcal |
# | 평영 | 50m | 5회 | 45초 | ~150kcal |
# | 배영 | 50m | 3회 | 45초 | ~100kcal |

# #### 🍔 토요일 특전: 치팅밀 가능!

# > **치팅밀이란?** 일주일에 1회, 좋아하는 음식을 먹는 날  
# > **효과**: 
# > - 🧠 심리적 만족감 ↑
# > - 🔥 대사율 회복
# > - 💪 다이어트 지속력 ↑
# > 
# > **규칙**: 
# > - ✅ 한 끼만! (점심 또는 저녁)
# > - ✅ 과식 금지 (배부른 정도만)
# > - ✅ 죄책감 느끼지 말기!

# #### ✅ 토요일 체크리스트

# - [ ] 유산소 60분 완료
# - [ ] 총 이동 거리 기록: ___km
# - [ ] 평균 심박수 기록: ___bpm
# - [ ] 치팅밀 즐기기 (선택)
# - [ ] 일주일 운동 복기 (무엇이 좋았나? 힘들었나?)

# ---

# ### 🗓️ 일요일: 완전 휴식 & 회복

# > **목표**: 다음 주를 위한 완벽한 재충전  

# #### 😴 회복 프로토콜

# | 활동 | 시간 | 중요도 | 효과 |
# |-----|------|-------|------|
# | 수면 | 8-9시간 | ⭐⭐⭐⭐⭐ | 근육 회복, 성장 호르몬 분비 |
# | 요가/명상 | 30분 | ⭐⭐⭐⭐ | 스트레스 해소, 유연성 |
# | 가벼운 산책 | 20분 | ⭐⭐⭐ | 소화 촉진, 혈액 순환 |
# | 반신욕 | 20분 | ⭐⭐⭐ | 근육통 완화 |
# | 마사지 | 30분 | ⭐⭐ | 근막 이완 |

# #### ✅ 일요일 체크리스트

# - [ ] 충분한 수면 (8시간 이상)
# - [ ] 가벼운 스트레칭 또는 요가
# - [ ] 다음 주 식단 장보기
# - [ ] 다음 주 운동 스케줄 확인
# - [ ] 이번 주 체중/체지방률 변화 기록
# - [ ] 운동복/신발 세탁 및 준비


### 🥗 화요일 식단

#### 🌅 아침 (7:00 AM) - 300kcal

# **메뉴: 그린 스무디**

# | 재료 | 수량 | 단백질 | 탄수화물 | 지방 |
# |-----|------|-------|---------|------|
# | 시금치 | 1컵 | 1g | 1g | 0g |
# | 바나나 | 1개 | 1g | 27g | 0g |
# | 아몬드 우유 | 200ml | 1g | 3g | 2.5g |
# | 프로틴 파우더 | 1스쿱 | 20g | 3g | 1.5g |
# | 치아씨드 | 1티스푼 | 2g | 2g | 2g |

# **조리법**:
# 1. 🥬 시금치를 깨끗이 씻어줍니다
# 2. 🍌 바나나를 한 입 크기로 자릅니다
# 3. 🥛 믹서에 모든 재료를 넣습니다
# 4. ⚡ 30-40초간 부드럽게 갈아줍니다

# **조리 시간**: ⏱️ 5분  
# **난이도**: ⭐ (초보자 가능)  
# **보관법**: 당일 섭취 권장 (2시간 내)  

# **💡 맛 개선 팁**:
# - 🍯 너무 씁쓸하면 꿀 1티스푼 추가
# - 🧊 얼음 3-4개 넣으면 시원하고 더 맛있음
# - 🥑 크리미한 식감 원하면 아보카도 1/4개 추가

# #### 🌞 점심 (12:30 PM) - 550kcal

# **메뉴: 연어구이와 고구마**

# | 재료 | 수량 | 단백질 | 탄수화물 | 지방 | 칼로리 | 오메가-3 |
# |-----|------|-------|---------|------|--------|---------|
# | 연어 | 150g | 35g | 0g | 15g | 280kcal | 2.5g ✨ |
# | 고구마 | 100g | 2g | 27g | 0g | 110kcal | - |
# | 브로콜리 | 1송이 | 3g | 7g | 0.5g | 35kcal | - |
# | 레몬 | 1/4개 | 0g | 1g | 0g | 5kcal | - |
# | 올리브유 | 1티스푼 | 0g | 0g | 5g | 45kcal | - |

# **조리법**:
# 1. 🐟 연어에 소금, 후추, 레몬즙으로 밑간 (10분)
# 2. 🍠 고구마를 찜기에 넣고 20분간 찝니다
# 3. 🥦 브로콜리는 끓는 물에 3분간 데칩니다
# 4. 🔥 팬에 올리브유를 두르고 연어를 앞뒤 각 4분씩 구웁니다
# 5. 🍽️ 접시에 예쁘게 담아냅니다

# **조리 시간**: ⏱️ 25분  
# **난이도**: ⭐⭐⭐ (중상급)  
# **보관법**: 냉장 보관 1일 가능  

# **💡 연어 굽기 완벽 가이드**:
# - 🔥 중불에서 천천히 (겉은 바삭, 속은 촉촉)
# - ⏰ 앞면 4분 → 뒤집어서 3분 (총 7분)
# - 🌡️ 내부 온도 63°C가 적정
# - 🍋 레몬을 마지막에 한 번 더 뿌리면 풍미 UP

# #### 🌙 저녁 (7:00 PM) - 500kcal

# **메뉴: 두부 비빔밥**

# | 재료 | 수량 | 단백질 | 탄수화물 | 지방 |
# |-----|------|-------|---------|------|
# | 두부 | 150g | 15g | 3g | 7.5g |
# | 현미밥 | 1공기 (210g) | 5g | 70g | 2g |
# | 쌈채소 | 50g | 2g | 3g | 0g |
# | 고추장 | 1스푼 | 1g | 10g | 0.5g |
# | 참기름 | 1티스푼 | 0g | 0g | 5g |
# | 김 | 2장 | 1g | 1g | 0g |

# **조리법**:
# 1. 🔥 두부를 팬에 구워 노릇노릇하게 만듭니다 (10분)
# 2. 🔪 구운 두부를 한 입 크기로 잘라줍니다
# 3. 🥗 쌈채소를 깨끗이 씻어 물기를 뺍니다
# 4. 🍚 그릇에 현미밥을 담고 두부를 올립니다
# 5. 🌶️ 고추장, 참기름을 넣고 쌈채소를 곁들입니다
# 6. 🍴 잘 비벼서 먹습니다

# **조리 시간**: ⏱️ 15분  
# **난이도**: ⭐ (초보자 가능)  
# **보관법**: 냉장 보관 1일 가능 (밥과 재료 따로)  

# ---

# ### 🥗 수요일 식단

# #### 🌅 아침 (7:00 AM) - 400kcal

# **메뉴: 요거트볼**

# | 재료 | 수량 | 단백질 | 탄수화물 | 지방 | 칼로리 | 프로바이오틱스 |
# |-----|------|-------|---------|------|--------|-------------|
# | 그릭 요거트 | 200g | 15g | 8g | 5g | 135kcal | ✨ 10억 CFU |
# | 블루베리 | 100g | 1g | 14g | 0.5g | 60kcal | - |
# | 그래놀라 | 30g | 3g | 20g | 5g | 130kcal | - |
# | 꿀 | 1티스푼 | 0g | 8g | 0g | 30kcal | - |
# | 아몬드 슬라이스 | 10g | 2g | 2g | 5g | 60kcal | - |

# **조리법**:
# 1. 🥣 그릭 요거트를 볼에 담습니다
# 2. 🫐 블루베리를 씻어 물기를 뺍니다
# 3. 🥜 그래놀라와 아몬드를 위에 뿌립니다
# 4. 🍯 마지막에 꿀을 살짝 둘러줍니다
# 5. 🍴 바로 먹거나 5분 불려서 먹으면 더 맛있음

# **조리 시간**: ⏱️ 5분  
# **난이도**: ⭐ (초보자 가능)  
# **보관법**: 당일 섭취 권장  

# **💡 그래놀라 선택 가이드**:
# - ✅ 설탕 함량 5g 이하 제품 선택
# - ✅ 견과류와 씨앗이 많이 들어간 제품
# - ❌ 초콜릿, 마시멜로 들어간 제품은 피하기


# ---

            refined_user_prompt = f"""다음 주간 계획을 사용자 친화적으로 요약해주세요:

{weekly_plan.llm_raw_output}"""

            print("  - 2차 LLM 호출 중...")
            refined_text = self.llm_client.generate_chat(
                refined_system_prompt, refined_user_prompt
            )
            print(f"  ✓ 요약 완료 ({len(refined_text)} 글자)")

            # 정제된 결과 DB 업데이트
            print("  - 정제된 요약 저장 중...")
            self.db.update_weekly_plan_refined_output(plan_id, refined_text)
            print(f"  ✓ Refined output 업데이트 완료")

            return plan_id, refined_text

        except Exception as e:
            print(f"  ⚠️  DB 저장 실패: {e}")
            import traceback

            traceback.print_exc()
            return 1, ""  # fallback
