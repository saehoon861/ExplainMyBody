# Pipeline InBody Analysis Multi - 3-Part LLM Analysis

## 개요

이 파이프라인은 인바디(InBody) 분석을 **3회의 독립적인 LLM 호출**로 나누어 수행합니다.
각 LLM 호출은 서로 다른 분석 영역에 집중하며, 최종적으로 3개의 결과를 결합하여 하나의 완전한 분석 리포트를 생성합니다.

## 왜 3-Part로 나누었나?

### 장점
1. **집중된 분석**: 각 LLM 호출이 특정 영역에만 집중하여 더 깊이 있는 분석 가능
2. **명확한 구조**: 분석 결과가 3개 파트로 명확히 구분되어 가독성 향상
3. **컨텍스트 관리**: 각 프롬프트가 짧아져 LLM의 집중력 향상
4. **모듈화**: 필요시 특정 파트만 수정하거나 재실행 가능

### 단점
1. **비용 증가**: LLM 호출이 1회 → 3회로 증가
2. **시간 증가**: 순차적으로 3번 호출하므로 처리 시간 약 3배
3. **중복 가능성**: 일부 내용이 파트 간 중복될 수 있음

## 3-Part 분석 구조

### Part 1: 기본 체성분 분석
**목적**: 기본적인 체성분 지표 평가

**분석 항목**:
- 종합 체형 평가 (BMI, 체지방률, 골격근량 기반)
- 체지방 상세 분석 (체지방률, 복부지방률, 내장지방 레벨)
- 근육량 상세 분석 (골격근량, 기초대사량)
- 기타 체성분 평가 (체수분, 단백질, 무기질)

**출력 형식**:
```
### [Part 1: 기본 체성분 분석]

#### 1. 종합 체형 평가
(체형 유형 및 주요 특징 3가지)

#### 2. 체지방 상세 분석
(체지방률, 복부지방, 내장지방, 건강 위험도)

#### 3. 근육량 상세 분석
(골격근량, 기초대사량, 체력 수준)

#### 4. 기타 체성분 평가
(체수분, 단백질, 무기질, 영양 상태)
```

### Part 2: 부위별 불균형 분석
**목적**: 신체 부위별 불균형 및 분포 패턴 분석

**분석 항목**:
- 근육 발달 불균형 (상체 vs 하체, 좌우 대칭성)
- 체지방 분포 불균형 (복부비만, 사지 vs 몸통)
- 체형 분류 해석 (Body Type 1/2)
- 대사 및 조절 목표 (기초대사량, 체중 조절 목표)

**출력 형식**:
```
### [Part 2: 부위별 불균형 분석]

#### 1. 근육 발달 불균형
(상하체 비교, 좌우 대칭, 취약 부위)

#### 2. 체지방 분포 불균형
(복부비만, 부위별 분포, 건강 위험 부위)

#### 3. 체형 분류 해석
(Body Type 1/2 결과 해석 - 있는 경우)

#### 4. 대사 및 조절 목표
(기초대사량, 체중 조절 목표, 우선순위)
```

### Part 3: 개선 과제 및 종합 평가
**목적**: 실행 가능한 개선 방향 및 우선순위 제시

**분석 항목**:
- 우선순위 개선 과제 (최우선/차순위/장기 과제)
- 개선 방향성 (체중 조절, 근육 발달, 체지방 관리)
- 기대 효과 및 목표 (3개월/6개월/1년)
- 종합 요약 (강점, 약점, 핵심 메시지)

**출력 형식**:
```
### [Part 3: 개선 과제 및 종합 평가]

#### 1. 우선순위 개선 과제

**최우선 과제 (즉시 개선 필요)**
- ...

**차순위 과제 (체형 개선 효과)**
- ...

**장기 과제 (점진적 개선)**
- ...

#### 2. 개선 방향성
(체중 조절, 근육 발달, 체지방 관리, 식습관)

#### 3. 기대 효과 및 목표
(3개월/6개월/1년 목표 및 예상 변화)

#### 4. 종합 요약
(강점, 약점, 핵심 메시지)
```

## 데이터 흐름

```
입력 데이터 (InBodyMeasurements)
    ↓
공통 데이터 생성 (_generate_common_data)
    ↓
3개 프롬프트 쌍 생성 (create_multi_part_prompts)
    ├─ Part 1: (system_prompt_1, user_prompt_1)
    ├─ Part 2: (system_prompt_2, user_prompt_2)
    └─ Part 3: (system_prompt_3, user_prompt_3)
    ↓
순차적 LLM 호출 (analyzer.py)
    ├─ LLM 호출 1 → analysis_part_1
    ├─ LLM 호출 2 → analysis_part_2
    └─ LLM 호출 3 → analysis_part_3
    ↓
3개 파트 결합
    analysis_text = "\n\n" + ("=" * 80 + "\n\n").join(analysis_parts)
    ↓
DB 저장 (inbody_analysis_reports 테이블)
    - llm_output: combined analysis_text
    - embedding_1536: OpenAI embedding
    - embedding_1024: Ollama bge-m3 embedding
    ↓
TXT 파일 출력
```

## 파일 구조

```
pipeline_inbody_analysis_multi/
├── __init__.py
├── prompt_generator.py          # 3-part 프롬프트 생성
│   ├── create_multi_part_prompts()   # 3개 프롬프트 쌍 생성
│   └── _generate_common_data()       # 공통 측정 데이터 포맷팅
├── analyzer.py                  # 3회 LLM 호출 및 결합
│   └── InBodyAnalyzer.analyze()      # 메인 분석 로직
├── embedder.py                  # 임베딩 생성
├── main.py                      # CLI 엔트리포인트
├── sample_inbody_data.json      # 샘플 데이터
└── WORKFLOW.md                  # 이 문서
```

## 실행 방법

### 기본 실행 (임베딩 없이)
```bash
python pipeline_inbody_analysis_multi/main.py \
  --user-id 1 \
  --measurements-file pipeline_inbody_analysis_multi/sample_inbody_data.json \
  --model gpt-4o-mini \
  --output-file outputs/inbody_analysis_multi_result.txt
```

### 임베딩 포함 실행
```bash
python pipeline_inbody_analysis_multi/main.py \
  --user-id 1 \
  --measurements-file pipeline_inbody_analysis_multi/sample_inbody_data.json \
  --model gpt-4o-mini \
  --enable-embedding \
  --output-file outputs/inbody_analysis_multi_result.txt
```

## 출력 예시

### 콘솔 출력
```
============================================================
InBody 분석 시작 (User ID: 1)
============================================================

📊 1단계: 체형 정보 확인...
  ✓ Body Type 1: 근육부족형
  ✓ Body Type 2: 복부비만형

💾 2단계: 측정 데이터 저장...
  ✓ Record ID: 123

🤖 3단계: LLM 분석 생성 (3-part 분할)...
  - Part 1/3: 기본 체성분 분석 LLM 호출 중...
  ✓ Part 1 완료 (1234 글자)
  - Part 2/3: 부위별 불균형 분석 LLM 호출 중...
  ✓ Part 2 완료 (1156 글자)
  - Part 3/3: 개선 과제 및 종합 평가 LLM 호출 중...
  ✓ Part 3 완료 (1089 글자)

  - 3개 파트 결합 중...
  ✓ 전체 분석 완료 (3479 글자)

💾 4단계: 분석 결과 저장...
  ✓ Analysis ID: 456

============================================================
✨ InBody 분석 완료!
============================================================
```

### TXT 파일 구조
```
============================================================
InBody 분석 결과
============================================================

Record ID: 123
Analysis ID: 456

------------------------------------------------------------

[콘솔 출력 메시지]

============================================================
📋 LLM 분석 리포트
============================================================

[Part 1: 기본 체성분 분석]
(LLM 생성 자연어 분석...)

================================================================================

[Part 2: 부위별 불균형 분석]
(LLM 생성 자연어 분석...)

================================================================================

[Part 3: 개선 과제 및 종합 평가]
(LLM 생성 자연어 분석...)
```

## 데이터베이스 저장

### inbody_analysis_reports 테이블
- `llm_output`: 3개 파트가 결합된 전체 분석 텍스트
- `embedding_1536`: OpenAI text-embedding-3-small (1536차원)
- `embedding_1024`: Ollama bge-m3 (1024차원)
- `model_version`: 사용된 LLM 모델명 (예: gpt-4o-mini)

### 검색 가능
결합된 분석 텍스트로 임베딩을 생성하므로, 3개 파트의 모든 내용이 벡터 검색에 반영됩니다.

## 단일 파이프라인과의 차이점

| 구분 | 단일 파이프라인 | 멀티 파이프라인 (이 파이프라인) |
|------|----------------|-------------------------------|
| LLM 호출 횟수 | 1회 | 3회 |
| 프롬프트 구조 | 1개 종합 프롬프트 | 3개 집중 프롬프트 |
| 분석 깊이 | 종합적 | 영역별 심화 |
| 처리 시간 | 빠름 | 느림 (약 3배) |
| 비용 | 저렴 | 비쌈 (약 3배) |
| 출력 구조 | 통합 서술 | 3-part 구분 |
| 가독성 | 보통 | 높음 (명확한 구분) |

## 참고 사항

1. **비용 고려**: LLM 호출이 3배이므로 API 비용도 약 3배 증가
2. **시간 고려**: 순차 처리로 인해 총 처리 시간도 약 3배 증가
3. **프롬프트 조정**: 각 파트의 프롬프트는 `prompt_generator.py`에서 독립적으로 수정 가능
4. **body_type1/2**: 외부에서 제공되는 체형 분류 결과 (선택사항)
5. **임베딩**: 3개 파트가 결합된 전체 텍스트로 생성되므로 모든 내용이 검색에 반영됨
