# OCR Pipeline 정리 

## 이미지 정렬 및 전처리

 입력 이미지는 촬영 환경에 따라 기울어지거나 원근이 들어가 있을 수 있다.
이를 보정하기 위해 auto_perspective=True인 경우, 문서의 윤곽선을 자동으로 검출해
필요하다고 판단될 때만 원근 변환(perspective transform)을 적용한다.
이 과정에서는 단순히 “사각형이 보이면 무조건 변환”하는 방식이 아니라,

- 문서 후보의 면적 비율(area_ratio)
- 문서의 기울기 점수(skew_score)

를 함께 계산해, 정말 기울어진 문서일 때만 변환이 이루어지도록 설계되어 있다.
이를 통해 이미 잘 찍힌 사진을 불필요하게 망가뜨리는 상황을 방지한다.
정렬이 끝난 이미지는 OCR 성능 향상을 위해 전처리를 거친다.
먼저 Hough 기반의 미세 기울기 보정(deskew)을 수행한 뒤,
BGR → LAB 색공간으로 변환하여 밝기 채널(L) 에만 CLAHE를 적용한다.
이 방식은 조명 차이로 인한 대비 문제를 줄이면서, 글자 영역을 또렷하게 만드는 데 목적이 있다.


## OCR 수행 및 텍스트 노드(node) 생성
 전처리된 이미지는 PaddleOCR의 predict()를 통해 OCR을 수행한다.
OCR 결과는 다음 세 가지 정보로 제공된다.

- dt_polys: 텍스트 영역의 다각형 좌표
- rec_texts: 인식된 문자열
- rec_scores: OCR 인식 신뢰도

코드는 이 결과를 기반으로, 각 텍스트를 하나의 node로 변환한다.
각 node는 다음 정보를 포함한다.

- text: 정리된 텍스트 문자열
- bbox: 바운딩 박스 (x_min, y_min, x_max, y_max)
- h: 텍스트 박스 높이
- center: 중심 좌표 (cx, cy)
- conf: OCR 신뢰도

여기서 (cx, cy)는 중심점 하나를 (x, y)로 표현한 값이며,
이 중심 좌표가 이후 모든 위치 기반 매칭의 기준이 된다.


## 키워드–값 매칭 (MatchConfig 기반)
OCR 결과에서 실제 필요한 값(BMI, 체지방률 등)을 찾기 위해
각 항목별로 MatchConfig라는 규칙 묶음을 사용한다.
MatchConfig에는 다음과 같은 정보가 포함된다.

- 정규식(regex)
- 탐색할 세로 범위(y_range)
- 값의 상대 위치(direction: right / down)
- 거리 허용치(x_tolerance, y_tolerance)
- 0값 허용 여부(allow_zero)

## 키워드 탐색
키워드를 찾는 과정에서는 먼저 y_range를 이용해 문서의 대략적인 세로 위치를 제한한다.
그 다음 OCR 오타 보정과 문자열 비교를 통해 키워드 후보를 수집하고,
여러 후보가 있을 경우 OCR 신뢰도(conf)가 가장 높은 node를 키워드로 선택한다.
값 매칭
값 탐색은 선택된 키워드 node를 기준으로 주변 숫자 node들을 후보로 모은 뒤,
거리 기반 점수(dist_score)를 계산해 경쟁시키는 방식으로 이루어진다.
이 점수는 세로 정렬(dy)을 매우 강하게 우선하도록 설계되어 있으며,
작은 글씨(눈금선 등)는 페널티를 주고 큰 글씨는 보너스를 주어
사람이 문서를 읽을 때와 유사한 판단을 하도록 구성되어 있다.
최종적으로 점수가 가장 낮은 후보가 해당 항목의 값으로 채택된다.
